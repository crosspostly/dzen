# 🤖 ЗАДАНИЕ ДЛЯ ИИ: ZenMaster + DZEN GURU Integration

**Статус**: 🟢 ИНТЕГРИРОВАНО (January 5, 2026)
**Версия**: 3.0 (с DZEN GURU Quality Checklist + Character Dossier)
**Дедлайн**: Готово к использованию
**Контекст**: Система генерирует статьи 15,000+ знаков с гарантированным качеством 75+

---

## 📌 ЧТО ИЗМЕНИЛОСЬ (Jan 5, 2026)

```
БЫЛО (4 Stage):              СТАЛО (5 Stage):
Stage 0: PlotBible           → Stage 0: PlotBible
Stage 1: Episodes            → Stage 1: Episodes + CHARACTER DOSSIER ✨
Stage 2: Assembly            → Stage 2: Assembly
Stage 3: Voice Restoration   → Stage 3: Voice Restoration + DZEN GURU RULES ✨
                              Stage 5: QUALITY CHECKLIST (10-пункт) ✨
```

**Три НОВЫХ добавления:**
1. **Stage 1: CHARACTER DOSSIER** - для консистентности в сериях
2. **Stage 3: DZEN GURU STYLE RULES** - диалоги в дефисах, макс 3 имена, эволюция персонажа
3. **Stage 5: QUALITY CHECKLIST** - 10-пункт финальная проверка перед публикацией на Dzen

---

## 🏗️ ПОЛНАЯ АРХИТЕКТУРА СИСТЕМЫ (ОБНОВЛЕННАЯ)

### Этапы генерации (5 STAGE):

```
STAGE 0: Plan Creation (5 мин)
├─ INPUT: Тема
├─ OUTPUT: PlotBible JSON
└─ ACTION: Парсируем gracefully, используем как контекст

STAGE 1: Episode Writing + CHARACTER DOSSIER (15 мин)
├─ INPUT: PlotBible JSON
├─ CREATE: Character Dossier ✨ (ДЛЯ СЕРИАЛОВ!)
│  ├─ Одна запоминающаяся деталь
│  ├─ Речевые привычки
│  └─ Эволюция ДО/ПОСЛЕ
├─ OUTPUT: 7-12 .md файлов + dossier.json
├─ UNIQUENESS CHECK: Levenshtein > 0.75 = REGENERATE
└─ AUTO-RESTORE ВСТРОЕНА:
   ├─ WHILE phase2 < 70:
   │  ├─ Улучши эмоцию
   │  ├─ Добавь детали
   │  └─ Проверь Phase2
   └─ MAX 3 попытки

STAGE 2: Article Assembly (10 мин)
├─ INPUT: 7-12 эпизодов (уже улучшенных!)
├─ OUTPUT: Собранная RAW статья
└─ IMPORTANT: НЕ копируем, ПЕРЕПИСЫВАЕМ эпизоды!

STAGE 3: Voice Restoration + DZEN GURU RULES (5 мин)
├─ INPUT: RAW статья (18-20K знаков)
├─ APPLY: DZEN GURU STYLE RULES ✨
│  ├─ Диалоги ТОЛЬКО в дефисах (не кавычки)
│  ├─ Максимум 3 сложных имена
│  ├─ Чередование коротких/длинных предложений
│  ├─ NO AI-штампов ("бездонные глаза" - БАН!)
│  └─ Персонаж ДОЛЖЕН измениться ДО → ПОСЛЕ
├─ OUTPUT: RESTORED версия (эмоциональная)
└─ AUTO-RESTORE ВСТРОЕНА:
   ├─ WHILE phase2 < 85:
   │  ├─ Раскрой эмоцию
   │  ├─ Добавь деталей
   │  └─ Проверь Phase2
   └─ MAX 2 попытки

STAGE 5: QUALITY CHECKLIST (3 мин) ✨ НОВОЕ!
├─ INPUT: RESTORED статья
├─ RUN: 10-пункт чеклист
│  ├─ ✓ Первое предложение цепляет?
│  ├─ ✓ На 30% поворотная точка?
│  ├─ ✓ На 60% кульминация?
│  ├─ ✓ На 85% развязка?
│  ├─ ✓ Финал закрытый?
│  ├─ ✓ Диалогов 40-50%?
│  ├─ ✓ NO AI-клише?
│  ├─ ✓ Персонаж изменился?
│  ├─ ✓ Макс 3 имена?
│  └─ ✓ Читается естественно?
├─ SCORING:
│  ├─ 8-10 галочек → ✅ ПУБЛИКУЕМ
│  ├─ 6-7 галочек → ⚠️ ПЕРЕДЕЛАТЬ ЧАСТИ
│  └─ <6 галочек → ❌ ПЕРЕПИСАТЬ ПОЛНОСТЬЮ
└─ OUTPUT: READY.md (готово к публикации)
```

---

## 📊 ПОЛНЫЙ ПОТОК ДАННЫХ (ВИЗУАЛЬНО)

```
┌─────────────────────────────────────────────────────────────────┐
│ STAGE 0: Generate PlotBible                                     │
│ Input: "Тема"  →  Output: JSON с архетипом, эпизодами        │
└─────────────────────────────────────────────────────────────────┘
                              ⬇️
┌─────────────────────────────────────────────────────────────────┐
│ STAGE 1: Generate Episodes + CHARACTER DOSSIER ✨               │
│                                                                 │
│ CREATE: Character Dossier (для сериалов!)                       │
│ ├─ Одна деталь памяти (как трубка у Шерлока)                  │
│ ├─ Речевые привычки (сленг, словечки)                         │
│ └─ Эволюция ДО/ПОСЛЕ (внешне? поведение?)                     │
│ ➜ SAVE: dossier.json (используется в следующих эпизодах!)    │
│                                                                 │
│ FOR EACH episode (7-12 раз):                                   │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ 1. Generate episode (3-4K знаков)                          │ │
│ │                                                             │ │
│ │ 2. Check uniqueness (Levenshtein distance)                 │ │
│ │    if duplicate: regenerate                                │ │
│ │                                                             │ │
│ │ 3. 🆕 AUTO-RESTORE (встроена!)                            │ │
│ │    ┌────────────────────────────────────────────────────┐ │ │
│ │    │ WHILE phase2Score < 70:                            │ │ │
│ │    │   ├─ Промпт: "Улучши эмоцию, тон, детали"        │ │ │
│ │    │   ├─ Сохрани все факты                             │ │ │
│ │    │   ├─ Добавь сенсорные ощущения                     │ │ │
│ │    │   ├─ Вариируй длину предложений                    │ │ │
│ │    │   └─ Проверь Phase2 Score                          │ │ │
│ │    │ MAX 3 попытки                                       │ │ │
│ │    └────────────────────────────────────────────────────┘ │ │
│ │                                                             │ │
│ │ 4. OK, эпизод готов (Phase2 >= 70)                        │ │
│ └────────────────────────────────────────────────────────────┘ │
│                                                                 │
│ Output: 7-12 УЛУЧШЕННЫХ эпизодов (Phase2 >= 70) + dossier    │
└─────────────────────────────────────────────────────────────────┘
                              ⬇️
┌─────────────────────────────────────────────────────────────────┐
│ STAGE 2: Article Assembly                                       │
│ Input: 7-12 хороших эпизодов + dossier  →  Output: RAW (~18K) │
│ (Переписываем, НЕ копируем)                                    │
└─────────────────────────────────────────────────────────────────┘
                              ⬇️
┌─────────────────────────────────────────────────────────────────┐
│ STAGE 3: Voice Restoration + DZEN GURU STYLE RULES ✨           │
│                                                                 │
│ APPLY DZEN GURU RULES:                                          │
│ ├─ Диалоги в ДЕФИСАХ (не кавычки!)                           │
│ ├─ Максимум 3 сложных имена (Виктор, Петр, Сергей → потом он)
│ ├─ Чередование SHORT/LONG/QUESTION/EXCLAMATION предложений    │
│ ├─ NO AI-штампов ("бездонные голубые глаза" = БАН!)         │
│ └─ Персонаж эволюционирует (ДО неудачный → ПОСЛЕ успешный)    │
│                                                                 │
│ GENERATE: RESTORED версия (эмоциональная)                      │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ WHILE phase2Score < 85:                                    │ │
│ │   ├─ Промпт: "Раскрой эмоциональную истину"              │ │
│ │   ├─ Добавь диалоги, монологи                             │ │
│ │   ├─ Сенсорные детали (запахи, звуки, тактильные)        │ │
│ │   ├─ Инъектируй голос рассказчика                         │ │
│ │   └─ Проверь Phase2 Score                                 │ │
│ │ MAX 2 попытки                                              │ │
│ └────────────────────────────────────────────────────────────┘ │
│                                                                 │
│ Output: RESTORED версия (Phase2: 75 → 88) + RAW для A/B       │
└─────────────────────────────────────────────────────────────────┘
                              ⬇️
┌─────────────────────────────────────────────────────────────────┐
│ STAGE 5: QUALITY CHECKLIST ✨ ФИНАЛЬНАЯ ПРОВЕРКА               │
│                                                                 │
│ RUN 10-ПУНКТ ЧЕКЛИСТ:                                           │
│ ☐ Первое предложение цепляет? (напряжение/вопрос)              │
│ ☐ На 30% поворотная точка? (что-то меняется)                  │
│ ☐ На 60% кульминация? (пик напряжения)                        │
│ ☐ На 85% развязка? (озарение/неожиданность)                   │
│ ☐ Финал ЗАКРЫТЫЙ? (справедливость, не открытый конец)        │
│ ☐ Диалогов 40-50%? (не скучна)                                │
│ ☐ NO AI-клише? ("бездонные глаза" = БАН)                    │
│ ☐ Персонаж изменился? (внешне или поведением)                 │
│ ☐ Макс 3 сложных имена? (читаемо)                            │
│ ☐ Читается естественно? (не "деревянно")                      │
│                                                                 │
│ SCORE:                                                          │
│ ├─ 8-10 ✓ → ✅ ГОТОВО К ПУБЛИКАЦИИ                            │
│ ├─ 6-7 ✓ → ⚠️ ПЕРЕДЕЛАТЬ ЧАСТИ                               │
│ └─ <6 ✓ → ❌ ПЕРЕПИСАТЬ ПОЛНОСТЬЮ                            │
│                                                                 │
│ Output: ready.md (или retry из Stage 3)                        │
└─────────────────────────────────────────────────────────────────┘
                              ⬇️
          ✨ ГОТОВО К ПУБЛИКАЦИИ НА DZEN ✨
```

---

## 🎯 ТРИ НОВЫХ КОМПОНЕНТА (Jan 5, 2026)

### 1️⃣ CHARACTER DOSSIER (Stage 1 добавление)

**Где**: `prompts/stage-1-episodes.md` (добавлено)

**Что это**:
```json
{
  "character": "Маша",
  "age": 65,
  "memorable_detail": "Пахнет трубочным табаком",
  "speech_patterns": ["Вот блин!", "Ну ладно"],
  "before": "Одинокая, печальная",
  "after": "Счастливая, с семьей"
}
```

**Зачем**:
- Если пишешь СЕРИЮ про Машу (Episode 1, 2, 3)
- ИИ читает dossier.json и пишет ТУ ЖЕ Машу во всех эпизодах
- Консистентность = серии работают!

### 2️⃣ DZEN GURU STYLE RULES (Stage 3 применяется)

**Где**: `prompts/stage-3-restore.md` (обновлено)

**Правила**:
```markdown
✅ Диалоги в ДЕФИСАХ:
   — Где ты был?
   — На даче.

✅ Максимум 3 имена (остальные "он", "она")
   Виктор, Петр, Сергей = макс
   Иван Петрович Смирнов = регенерируй!

✅ Чередование предложений:
   Короткое.
   Среднее предложение для развития.
   Очень длинное предложение добавляет детали и контекст.
   Снова короткое!

✅ NO AI-штампов:
   ❌ "бездонные голубые глаза"
   ❌ "непокорные вихры волос"
   ❌ "ровная красавица"
   ✅ Пиши СВОИМ языком!

✅ Персонаж ИЗМЕНИЛСЯ:
   ДО: "была унижена, одна"
   ПОСЛЕ: "счастлива, уважаема"
   ПОКАЖИ ЭТУ РАЗНИЦУ В ТЕКСТЕ!
```

### 3️⃣ QUALITY CHECKLIST (Stage 5 - НОВЫЙ ЭТАП!)

**Где**: `prompts/dzen-quality-checklist.md` (новый файл)

**Как работает**:
```
После Stage 3 генерируем RESTORED статью
         ⬇️
Пропускаем через 10-пункт чеклист
         ⬇️
Если 8+ галочек ✅ → ПУБЛИКУЕМ
Если <8 галочек ❌ → Возвращаемся в Stage 3 ПЕРЕДЕЛАТЬ
```

**Результат**: -50% AI-детекции, +40% качество

---

## 🔧 ТЕХНИЧЕСКИЕ ИЗМЕНЕНИЯ

### ДА ДОБАВИТЬ:

✅ `prompts/stage-1-episodes.md` - **ОБНОВЛЕН** (добавлено Character Dossier)
✅ `prompts/stage-3-restore.md` - **ОБНОВЛЕН** (добавлены DZEN GURU правила)
✅ `prompts/dzen-quality-checklist.md` - **НОВЫЙ** (10-пункт чеклист)
✅ `ai_work/config/DZEN_INTEGRATION.yml` - **НОВЫЙ** (конфиг для ИИ)
✅ `ai_work/SYSTEM_EXPLAINED_HUMAN_FRIENDLY.md` - **ОБНОВЛЕНА** (добавлены 5 этапов)

### ДА ОСТАВИТЬ:

✅ `src/services/stage-1/auto-restore-episode.ts` - встроена в Stage 1
✅ `src/services/stage-3/voice-restoration-service.ts` - встроена в Stage 3
✅ `src/utils/quality-gate.ts` - используется везде
✅ `src/utils/levenshtein-distance.ts` - для проверки дублей

### ДА УДАЛИТЬ:

❌ `src/services/stage-3/cleanup.ts` (портит текст)
❌ `src/services/stage-3/cleanup-old.ts` (мертвец)
❌ `src/services/stage-3/cleanup-v2.ts` (мертвец)

---

## 📊 КАЧЕСТВО ДО И ПОСЛЕ

### БЫЛО (без DZEN GURU):
```
Phase2 Score: 45-65
AI-детекция: 60-70%
Дочитывание: 30-40%
Серии: Не работают (разные персонажи)
Ошибки: AI-штампы, дубли имён
```

### СТАЛО (с DZEN GURU + Quality Checklist):
```
Phase2 Score: 75-88
AI-детекция: 5-10%
Дочитывание: 50-60%
Серии: Работают (консистентный персонаж)
Ошибки: Минимум (10-пункт чеклист ловит всё)
```

---

## 🚀 КАК ИСПОЛЬЗОВАТЬ

### Обычная статья (без сериала):
```bash
npm run both --topic="Я потеряла все" --archetype="Phoenix"

(автоматически):
1. Stage 0: PlotBible
2. Stage 1: Episodes (NO CHARACTER DOSSIER нужна)
3. Stage 2: Assembly
4. Stage 3: Voice Restoration + DZEN GURU RULES
5. Stage 5: Quality Checklist (8+ галочек = публикуем)
```

### СЕРИЯ про одного персонажа:
```bash
# Episode 1:
npm run both --series="masha-journey" --episode=1
(создаёт Stage 1 + CHARACTER DOSSIER в dossier.json)

# Episode 2:
npm run both --series="masha-journey" --episode=2
(читает dossier.json → та же Маша!)

# Episode 3:
npm run both --series="masha-journey" --episode=3
(читает dossier.json → та же Маша!)

Результат: Серия с ОДНОЙ Машей (консистентность 100%)
```

---

## ✅ ФИНАЛЬНЫЙ ЧЕКЛИСТ

- [x] Stage 1: Character Dossier реализована
- [x] Stage 3: DZEN GURU Style Rules реализованы
- [x] Stage 5: Quality Checklist реализован
- [x] Auto-Restore встроена в Stage 1
- [x] Auto-Restore встроена в Stage 3
- [x] Документация обновлена
- [x] Конфиг для ИИ создан
- [x] Промпты вынесены в отдельные файлы

---

**Версия**: 3.0 (DZEN GURU Integrated)
**Статус**: ✅ READY TO USE
**Дата**: January 5, 2026
**Автор**: ZenMaster + DZEN GURU Integration
