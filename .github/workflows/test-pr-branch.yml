name: üß™ Test PR Branch - Safe Testing

on:
  workflow_dispatch:
    inputs:
      pr_url:
        description: 'PR URL (e.g., https://github.com/crosspostly/dzen/pull/92)'
        required: true
        type: string
      count:
        description: 'Number of articles to generate'
        required: false
        default: '1'
        type: choice
        options:
          - '1'
          - '3'
          - '5'
      channel:
        description: 'Channel/theme'
        required: false
        default: 'women-35-60'
        type: choice
        options:
          - 'women-35-60'
          - 'young-moms'
          - 'men-25-40'
          - 'teens'
      images:
        description: 'Generate images'
        required: false
        default: true
        type: boolean
      skip_merge:
        description: 'Skip merge to main (for testing only)'
        required: false
        default: false
        type: boolean

jobs:
  extract-pr-info:
    name: üìã Extract PR Info
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.extract.outputs.pr_number }}
      branch_name: ${{ steps.pr_details.outputs.branch_name }}
      pr_title: ${{ steps.pr_details.outputs.pr_title }}
      author: ${{ steps.pr_details.outputs.author }}
    steps:
      - name: Extract PR number from URL
        id: extract
        run: |
          PR_URL="${{ inputs.pr_url }}"
          
          # Extract PR number (last number after pull/)
          PR_NUMBER=$(echo "$PR_URL" | grep -oP 'pull/\K[0-9]+' || echo "")
          
          if [ -z "$PR_NUMBER" ]; then
            echo "‚ùå Invalid PR URL format"
            echo "Expected: https://github.com/owner/repo/pull/NUMBER"
            exit 1
          fi
          
          echo "‚úÖ Extracted PR #$PR_NUMBER"
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "pr_url=${{ inputs.pr_url }}" >> $GITHUB_OUTPUT
          
      - name: Checkout main to get PR info
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR details via GitHub API
        id: pr_details
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.extract.outputs.pr_number }}"
          
          # Get PR info
          PR_DATA=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER)
          
          BRANCH_NAME=$(echo "$PR_DATA" | jq -r '.head.ref')
          PR_TITLE=$(echo "$PR_DATA" | jq -r '.title')
          AUTHOR=$(echo "$PR_DATA" | jq -r '.user.login')
          
          echo "‚úÖ PR #$PR_NUMBER found"
          echo "   Branch: $BRANCH_NAME"
          echo "   Title: $PR_TITLE"
          echo "   Author: $AUTHOR"
          
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
          echo "author=$AUTHOR" >> $GITHUB_OUTPUT

  test-pr-branch:
    name: üß™ Test Branch
    needs: extract-pr-info
    runs-on: ubuntu-latest
    env:
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      API_KEY: ${{ secrets.GEMINI_API_KEY }}
      # v6.0: Article Cleanup System
      FINAL_CLEANUP_ENABLED: true
      CLEANUP_THRESHOLD: medium
      CLEANUP_MODEL: gemini-2.0-flash
      CLEANUP_TEMPERATURE: 0.3
      CLEANUP_MAX_RETRIES: 2
    steps:
      - name: üì• Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.extract-pr-info.outputs.branch_name }}
          fetch-depth: 0

      - name: ‚ÑπÔ∏è  Display PR Info
        run: |
          echo "=========================================="
          echo "üß™ Testing PR #${{ needs.extract-pr-info.outputs.pr_number }}"
          echo "=========================================="
          echo ""
          echo "PR Title: ${{ needs.extract-pr-info.outputs.pr_title }}"
          echo "Author: ${{ needs.extract-pr-info.outputs.author }}"
          echo "Branch: ${{ needs.extract-pr-info.outputs.branch_name }}"
          echo "URL: ${{ inputs.pr_url }}"
          echo ""
          echo "Test Config:"
          echo "  Count: ${{ inputs.count }}"
          echo "  Channel: ${{ inputs.channel }}"
          echo "  Images: ${{ inputs.images }}"
          echo "=========================================="

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: npm ci

      - name: ‚úÖ Validate environment
        run: npx tsx test-github-actions-env.ts

      - name: üß™ Run cleanup system tests
        run: npx tsx test-article-cleanup-system.ts

      - name: üèÉ Generate test articles
        id: generate
        run: |
          echo "üöÄ Generating ${{ inputs.count }} articles from PR branch..."
          npm run factory -- \
            --count=${{ inputs.count }} \
            --channel=${{ inputs.channel }} \
            --images=${{ inputs.images }}
          
          echo "‚úÖ Generation complete!"
          echo "generated=true" >> $GITHUB_OUTPUT

      - name: üìä Display results
        if: steps.generate.outputs.generated == 'true'
        run: |
          echo "=========================================="
          echo "‚úÖ GENERATION SUCCESSFUL"
          echo "=========================================="
          echo ""
          echo "Generated from PR branch:"
          echo "  Branch: ${{ needs.extract-pr-info.outputs.branch_name }}"
          echo "  PR: #${{ needs.extract-pr-info.outputs.pr_number }}"
          echo "  Articles: ${{ inputs.count }}"
          echo "  Channel: ${{ inputs.channel }}"
          echo "  Images: ${{ inputs.images }}"
          echo ""
          ls -la articles/${{ inputs.channel }}/ 2>/dev/null || echo "No articles found"
          echo "=========================================="

      - name: üì§ Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-${{ needs.extract-pr-info.outputs.pr_number }}-test-results
          path: |
            articles/
            output/
            test-output/
          retention-days: 30

      - name: üíæ Commit test results to main (if enabled)
        if: success() && inputs.skip_merge == false
        run: |
          echo "üîÑ Setting up git..."
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Actions"
          
          echo "üìã Checking out main branch..."
          git fetch origin main
          git checkout main
          
          echo "üì• Copying test results from PR branch..."
          git checkout ${{ needs.extract-pr-info.outputs.branch_name }} -- articles/ output/ test-output/ .env.example 2>/dev/null || true
          
          echo "üìù Checking for changes..."
          git status
          
          if [ -n "$(git status --porcelain)" ]; then
            echo "‚úÖ Changes detected, committing..."
            
            COMMIT_MSG="‚úÖ Test results from PR #${{ needs.extract-pr-info.outputs.pr_number }}

üß™ Branch: ${{ needs.extract-pr-info.outputs.branch_name }}
üìù Title: ${{ needs.extract-pr-info.outputs.pr_title }}
üë§ Author: ${{ needs.extract-pr-info.outputs.author }}

üî¨ Test Configuration:
  - Articles: ${{ inputs.count }}
  - Channel: ${{ inputs.channel }}
  - Images: ${{ inputs.images }}
  - Cleanup System: ‚úÖ v6.0 Active

‚ú® All tests passed successfully!"
            
            git add articles/ output/ test-output/ .env.example 2>/dev/null || true
            git commit -m "$COMMIT_MSG" || echo "No changes to commit"
            
            echo "üöÄ Pushing to main..."
            git push origin main
            
            echo "‚úÖ Commit successful!"
          else
            echo "‚ÑπÔ∏è  No changes to commit"
          fi

  summary:
    name: üìã Summary
    needs: [extract-pr-info, test-pr-branch]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ‚úÖ Test Summary
        run: |
          echo "=========================================="
          echo "‚úÖ PR BRANCH TEST COMPLETED"
          echo "=========================================="
          echo ""
          echo "PR Information:"
          echo "  PR Number: #${{ needs.extract-pr-info.outputs.pr_number }}"
          echo "  Title: ${{ needs.extract-pr-info.outputs.pr_title }}"
          echo "  Branch: ${{ needs.extract-pr-info.outputs.branch_name }}"
          echo "  Author: ${{ needs.extract-pr-info.outputs.author }}"
          echo ""
          echo "Test Results:"
          if [ "${{ needs.test-pr-branch.result }}" == "success" ]; then
            echo "  Status: ‚úÖ SUCCESS"
          else
            echo "  Status: ‚ùå FAILED"
          fi
          echo ""
          echo "Articles generated:"
          echo "  Count: ${{ inputs.count }}"
          echo "  Channel: ${{ inputs.channel }}"
          echo "  Images: ${{ inputs.images }}"
          echo ""
          echo "Results:"
          if [ "${{ inputs.skip_merge }}" == "true" ]; then
            echo "  üì¶ Artifacts: Uploaded (30 days)"
            echo "  üîÑ Main branch: NOT updated (testing mode)"
          else
            echo "  üì¶ Artifacts: Uploaded (30 days)"
            echo "  üîÑ Main branch: UPDATED ‚úÖ"
          fi
          echo "=========================================="

      - name: ‚ùå Error Notification
        if: failure()
        run: |
          echo "‚ùå TESTS FAILED"
          echo ""
          echo "Check logs above for details"
          exit 1
