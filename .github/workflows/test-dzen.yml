name: Test Dzen Setup

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: windows-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Check feed.xml location
        run: |
          Write-Host "üîç Checking feed.xml locations..."
          
          if (Test-Path "public/feed.xml") {
            Write-Host "‚úÖ Found: public/feed.xml"
            $size = (Get-Item "public/feed.xml").Length / 1KB
            Write-Host "   Size: $([Math]::Round($size, 2)) KB"
          }
          
          if (Test-Path "!posts/PRODUCTION_READY/public/feed.xml") {
            Write-Host "‚úÖ Found: !posts/PRODUCTION_READY/public/feed.xml"
            $size = (Get-Item "!posts/PRODUCTION_READY/public/feed.xml").Length / 1KB
            Write-Host "   Size: $([Math]::Round($size, 2)) KB"
          }
        shell: pwsh
      
      - name: Test with GitHub Secret
        env:
          DZEN_COOKIES_JSON: ${{ secrets.DZEN_COOKIES_JSON }}
        run: |
          Write-Host "üîê Testing GitHub Secret..."
          
          $secretValue = $env:DZEN_COOKIES_JSON
          
          if ([string]::IsNullOrWhiteSpace($secretValue)) {
            Write-Host "‚ö†Ô∏è  Secret DZEN_COOKIES_JSON not found or empty"
            Write-Host "   Add it to: Settings > Secrets > New Secret"
            Write-Host "   Name: DZEN_COOKIES_JSON"
            Write-Host "   Value: (paste your JSON cookies directly)"
            exit 0
          }
          
          Write-Host "‚úÖ Secret DZEN_COOKIES_JSON found!"
          Write-Host "   Size: $($secretValue.Length) characters"
          
          # Test parsing with error handling
          try {
            # Try to parse directly
            $json = $secretValue | ConvertFrom-Json -ErrorAction Stop
            
            # Check if we got a string back (double-encoded case) and try to parse again if needed
            if ($json -is [string]) {
               Write-Host "‚ö†Ô∏è  Detected double-encoded JSON string, parsing again..."
               $json = $json | ConvertFrom-Json -ErrorAction Stop
            }

            $count = if ($json -is [array]) { $json.Count } else { 1 }
            Write-Host "‚úÖ Valid JSON: $count items parsed successfully"
            
            # Show cookie names if available
            if ($json -is [array]) {
              $names = $json | Select-Object -ExpandProperty name -ErrorAction SilentlyContinue
              if ($names) {
                Write-Host "   Cookie names: $($names -join ', ')"
              }
            } elseif ($null -ne $json.name) {
              Write-Host "   Cookie name: $($json.name)"
            }
          } catch {
            Write-Host "‚ùå JSON Parse Error!"
            Write-Host "   Error: $($_.Exception.Message)"
            Write-Host ""
            Write-Host "üîç Troubleshooting:"
            Write-Host "   1. Check Secret value in Settings > Secrets"
            Write-Host "   2. Paste your JSON directly"
            Write-Host "   3. Validate with: https://jsonlint.com"
            Write-Host ""
            Write-Host "   First 200 chars of secret:"
            $preview = if ($secretValue.Length -gt 200) { 
              $secretValue.Substring(0, 200) + "..." 
            } else { 
              $secretValue 
            }
            Write-Host "   $preview"
            exit 1
          }
        shell: pwsh
      
      - name: Run test-setup.js if exists
        run: |
          if (Test-Path "!posts/PRODUCTION_READY/test-setup.js") {
            Write-Host "üß™ Running test-setup.js..."
            cd "!posts\\PRODUCTION_READY"
            node test-setup.js
          } else {
            Write-Host "‚ö†Ô∏è  test-setup.js not found in !posts/PRODUCTION_READY/"
          }
        shell: pwsh
        continue-on-error: true
      
      - name: Summary
        run: |
          Write-Host ""
          Write-Host "‚úÖ TEST SETUP COMPLETED" -ForegroundColor Green
          Write-Host ""
          Write-Host "üîç What was checked:"
          Write-Host "   ‚úÖ feed.xml location"
          Write-Host "   ‚úÖ GitHub Secret DZEN_COOKIES_JSON"
          Write-Host "   ‚úÖ JSON parsing"
          Write-Host "   ‚úÖ test-setup.js availability"
          Write-Host ""
          Write-Host "üîó Next steps:"
          Write-Host "   1. Add GitHub Secret: DZEN_COOKIES_JSON"
          Write-Host "   2. Run: Auto-Publish to Dzen Every 3 Hours workflow"
          Write-Host "   3. Check logs for any errors"
          Write-Host ""
        shell: pwsh
