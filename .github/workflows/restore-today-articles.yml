name: âœ¨ Restore Today's Articles

on:
  workflow_dispatch:
    inputs:
      hours_back:
        description: 'Hours back to check (default: 24)'
        required: false
        default: '24'

jobs:
  restore-today:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: ğŸ“… Get today's articles (RECURSIVE)
        id: files
        shell: bash
        run: |
          HOURS_BACK="${INPUT_HOURS:-24}"
          CURRENT_TIME=$(date +%s)
          TIME_LIMIT=$((CURRENT_TIME - (HOURS_BACK * 3600)))
          
          echo "â° Checking articles modified in last ${HOURS_BACK} hours"
          echo "   Current time: $(date -d @${CURRENT_TIME} '+%Y-%m-%d %H:%M:%S UTC')"
          echo "   Time limit:   $(date -d @${TIME_LIMIT} '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "ğŸ” Searching RECURSIVELY in articles/**/*.md"
          echo ""
          
          CHANGED=""
          FILE_COUNT=0
          
          # ĞĞĞ™Ğ”Ğ­Ğœ Ğ Ğ•ĞšĞ£Ğ Ğ¡Ğ˜Ğ’ĞĞ Ğ’Ğ¡Ğ• .md Ñ„Ğ°Ğ¹Ğ»Ñ‹
          find articles -type f -name "*.md" -print0 2>/dev/null | while IFS= read -r -d '' file; do
            # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ğ¼ Ğ²Ñ€ĞµĞ¼Ñ ĞŸĞĞ¡Ğ›Ğ•Ğ”ĞĞ•Ğ“Ğ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ² unix timestamp
            FILE_TIME=$(git log -1 --format=%at -- "$file" 2>/dev/null || echo "0")
            
            if [ -z "$FILE_TIME" ] || [ "$FILE_TIME" = "0" ]; then
              # ĞĞ¾Ğ²Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ» - Ğ±ĞµÑ€Ñ‘Ğ¼!
              COMMIT_TIME=$(date '+%Y-%m-%d %H:%M:%S UTC')
              echo "âœ¨ $file (NEW FILE - $COMMIT_TIME)"
              CHANGED="$CHANGED $file"
              FILE_COUNT=$((FILE_COUNT + 1))
            elif [ "$FILE_TIME" -gt "$TIME_LIMIT" ]; then
              # ĞœĞ¾Ğ´Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ² Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ N Ñ‡Ğ°ÑĞ¾Ğ² - Ğ±ĞµÑ€Ñ‘Ğ¼!
              COMMIT_TIME=$(date -d @${FILE_TIME} '+%Y-%m-%d %H:%M:%S UTC')
              echo "âœï¸  $file ($COMMIT_TIME)"
              CHANGED="$CHANGED $file"
              FILE_COUNT=$((FILE_COUNT + 1))
            fi
          done
          
          if [ -z "$CHANGED" ]; then
            echo ""
            echo "âŒ No articles modified in last ${HOURS_BACK} hours"
            echo "exit=empty" >> $GITHUB_OUTPUT
          else
            echo ""
            echo "ğŸ“ Found: $FILE_COUNT files"
            echo ""
            echo "$CHANGED" | xargs echo "Files:" 
            
            # ĞÑ‡ĞµĞ½ÑŒ Ğ²Ğ°Ğ¶Ğ½Ğ¾: ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ² OUTPUT
            FILES_STR=$(echo "$CHANGED" | sed 's/^[[:space:]]*//g')
            echo "files=$FILES_STR" >> $GITHUB_OUTPUT
            echo "exit=ok" >> $GITHUB_OUTPUT
          fi
        env:
          INPUT_HOURS: ${{ github.event.inputs.hours_back }}

      - name: ğŸ¤– Restore articles with Gemini
        if: steps.files.outputs.exit == 'ok'
        id: restore
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ğŸš€ Restoring $(echo '${{ steps.files.outputs.files }}' | wc -w) articles..."
          echo ""
          
          FILES="${{ steps.files.outputs.files }}"
          
          # Ñ€Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ ĞºĞ¾Ğ»-Ğ²Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
          COUNT=$(echo "$FILES" | wc -w)
          echo "ğŸ“Š Processing $COUNT files..."
          echo ""
          
          node scripts/restore-articles.js $FILES
          EXIT_CODE=$?
          
          echo ""
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… Restore completed successfully"
          else
            echo "âš ï¸  Restore failed with code $EXIT_CODE"
          fi

      - name: ğŸ“¤ Commit and PUSH to GitHub
        if: steps.files.outputs.exit == 'ok' && steps.restore.outputs.exit_code == '0'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          echo "ğŸ” Checking for changes..."
          
          # ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»Ğ¾ÑÑŒ
          if git diff --name-only; then
            echo ""
            echo "ğŸ“‘ Changes detected:"
            git diff --stat
            echo ""
            
            # ĞĞ´Ğ´Ğ¸Ğ¼ Ğ²ÑÑ‘ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ½Ğ¾Ğµ
            git add -A articles/
            
            # ĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ¸Ğ¼
            git commit -m "âœ¨ Restore: Updated articles formatting [skip ci]" --no-verify || true
            
            echo "ğŸš€ Pushing to GitHub..."
            git push origin main -v
            
            echo ""
            echo "âœ… Successfully pushed to main!"
          else
            echo "â„¹ï¸  No changes detected after restoration"
          fi

      - name: âœ… Summary
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          if [ "${{ steps.files.outputs.exit }}" = "ok" ]; then
            echo "â•‘ âœ¨ Restore Complete âœ¨                 â•‘"
          else
            echo "â•‘ â„¹ï¸  No articles to restore              â•‘"
          fi
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Hours back: ${{ github.event.inputs.hours_back || 24 }}"
          echo "Files: $(echo '${{ steps.files.outputs.files }}' | wc -w)"
          echo "Status: $([ "${{ steps.restore.outputs.exit_code }}" = "0" ] && echo 'âœ… Restored & Pushed' || echo 'âš ï¸  Failed')"
          echo ""
