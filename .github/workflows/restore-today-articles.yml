name: âœ¨ Restore Today's Articles

on:
  workflow_dispatch:
    inputs:
      hours_back:
        description: 'Hours back to check (default: 24)'
        required: false
        default: '24'

jobs:
  restore-today:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: ğŸ“… Get today's articles (RECURSIVE FIX)
        id: files
        shell: bash
        run: |
          HOURS_BACK="${INPUT_HOURS:-24}"
          CURRENT_TIME=$(date +%s)
          TIME_LIMIT=$((CURRENT_TIME - (HOURS_BACK * 3600)))
          
          echo "â° Checking articles modified in last ${HOURS_BACK} hours"
          echo "   Current time: $(date -d @${CURRENT_TIME} '+%Y-%m-%d %H:%M:%S UTC')"
          echo "   Time limit:   $(date -d @${TIME_LIMIT} '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "ğŸ” Searching RECURSIVELY in articles/**/*.md"
          echo ""
          
          # ğŸ”´ ĞĞ• Ğ˜Ğ¡ĞŸĞĞ›Ğ¬Ğ—Ğ£Ğ•Ğœ piped while (Ñ‚ĞµÑ€ÑĞµÑ‚ÑÑ subshell)
          # âœ… Ğ˜Ğ¡ĞŸĞĞ›Ğ¬Ğ—Ğ£Ğ•Ğœ array + for loop
          
          declare -a FILES_ARRAY
          FILE_COUNT=0
          
          # ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ²ÑĞµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ñ€ĞµĞºÑƒÑ€ÑĞ¸Ğ²Ğ½Ğ¾
          while IFS= read -r -d '' file; do
            # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ timestamp Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ³Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
            FILE_TIME=$(git log -1 --format=%at -- "$file" 2>/dev/null)
            
            if [ -z "$FILE_TIME" ]; then
              FILE_TIME=0
            fi
            
            # Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ğ²Ğ°ĞµĞ¼
            if [ "$FILE_TIME" -gt "$TIME_LIMIT" ]; then
              COMMIT_TIME=$(date -d @${FILE_TIME} '+%Y-%m-%d %H:%M:%S UTC')
              echo "âœï¸  $file ($COMMIT_TIME)"
              FILES_ARRAY+=("$file")
              FILE_COUNT=$((FILE_COUNT + 1))
            fi
          done < <(find articles -type f -name "*.md" -print0 2>/dev/null)
          
          echo ""
          
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "âŒ No articles found"
            echo "exit=empty" >> $GITHUB_OUTPUT
            echo "files_count=0" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“ Found: $FILE_COUNT files"
            echo ""
            
            # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ² OUTPUT
            FILES_STR="${FILES_ARRAY[*]}"
            echo "files=$FILES_STR" >> $GITHUB_OUTPUT
            echo "files_count=$FILE_COUNT" >> $GITHUB_OUTPUT
            echo "exit=ok" >> $GITHUB_OUTPUT
            
            echo "âœ… Files saved to output"
          fi
        env:
          INPUT_HOURS: ${{ github.event.inputs.hours_back }}

      - name: ğŸ¤– Restore articles with Gemini
        if: steps.files.outputs.exit == 'ok'
        id: restore
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ğŸš€ Restoring ${{ steps.files.outputs.files_count }} articles..."
          echo ""
          
          FILES="${{ steps.files.outputs.files }}"
          
          # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ restore
          node scripts/restore-articles.js $FILES
          EXIT_CODE=$?
          
          echo ""
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… Restore completed successfully"
          else
            echo "âš ï¸  Restore failed with code $EXIT_CODE"
          fi

      - name: ğŸ“¤ Commit and PUSH to GitHub
        if: steps.files.outputs.exit == 'ok' && steps.restore.outputs.exit_code == '0'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          echo "ğŸ” Checking for changes..."
          echo ""
          
          # ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»Ğ¾ÑÑŒ
          if git diff --quiet; then
            echo "â„¹ï¸  No changes detected after restoration"
          else
            echo "ğŸ“‹ Changes detected:"
            git diff --stat
            echo ""
            
            # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ²ÑĞµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
            git add -A articles/
            
            # ĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ¸Ğ¼
            git commit -m "âœ¨ Restore: Updated articles formatting [skip ci]" --no-verify || true
            
            echo "ğŸš€ Pushing to GitHub..."
            git push origin main -v
            
            echo ""
            echo "âœ… Successfully pushed to main!"
          fi

      - name: âœ… Summary
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          if [ "${{ steps.files.outputs.exit }}" = "ok" ]; then
            echo "â•‘  âœ¨ Restore Complete - ${{ steps.files.outputs.files_count }} articles         â•‘"
          else
            echo "â•‘  â„¹ï¸  No articles to restore                          â•‘"
          fi
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Hours back: ${{ github.event.inputs.hours_back || 24 }}"
          echo "Files found: ${{ steps.files.outputs.files_count || 0 }}"
          echo "Status: $([ "${{ steps.restore.outputs.exit_code }}" = "0" ] && echo 'âœ… Restored & Pushed' || echo 'âš ï¸  Check logs')"
          echo ""
