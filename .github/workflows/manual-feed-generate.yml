name: Manual Feed Generation

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Generation mode'
        required: true
        default: 'incremental'
        type: choice
        options:
          - full
          - incremental

jobs:
  generate-feed:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: ğŸ” Debug - Check articles structure (FULL listing)
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ—‚ï¸  Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° articles/:" 
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          find articles -type f \( -name "*.md" -o -name "*.jpg" \) | sort | head -30
          echo ""
          echo "ğŸ“Š Ğ¡Ğ¢ĞĞ¢Ğ˜Ğ¡Ğ¢Ğ˜ĞšĞ:"
          echo "  .md Ñ„Ğ°Ğ¹Ğ»Ñ‹: $(find articles -type f -name '*.md' 2>/dev/null | wc -l)"
          echo "  .jpg Ñ„Ğ°Ğ¹Ğ»Ñ‹: $(find articles -type f -name '*.jpg' 2>/dev/null | wc -l)"
          echo ""
          echo "ğŸ“ Ğ¡Ğ¢Ğ Ğ£ĞšĞ¢Ğ£Ğ Ğ ĞŸĞĞŸĞĞš:"
          tree -L 4 -d articles/ 2>/dev/null || find articles -type d | head -20

      - name: ğŸ” Debug - Check for timestamp suffixes in filenames
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš ï¸  ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ñ timestamp Ğ² Ğ¸Ğ¼ĞµĞ½Ğ¸:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Check for files with timestamp pattern (-1766318654134 or similar)
          TIMESTAMP_FILES=$(find articles -type f \( -name "*-[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]*" \) 2>/dev/null | wc -l)
          
          if [ "$TIMESTAMP_FILES" -gt 0 ]; then
            echo "âŒ ĞĞĞ™Ğ”Ğ•ĞĞ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ñ timestamp Ğ² Ğ¸Ğ¼ĞµĞ½Ğ¸: $TIMESTAMP_FILES"
            find articles -type f -name "*-[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]*" 2>/dev/null | head -10
            echo ""
            echo "âš ï¸  Ğ­Ñ‚Ğ¸ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¾Ñ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¾Ñ‚ timestamp!"
          else
            echo "âœ… Ğ’ÑĞµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ñ‡Ğ¸ÑÑ‚Ñ‹Ğµ (Ğ±ĞµĞ· timestamp)!"
          fi
          echo ""

      - name: ğŸ” Debug - Detailed path analysis
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ ĞĞĞĞ›Ğ˜Ğ— ĞŸĞ£Ğ¢Ğ•Ğ™ Ğ”Ğ›Ğ¯ RSS Ğ“Ğ•ĞĞ•Ğ ĞĞ¢ĞĞ Ğ:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          echo "1ï¸âƒ£  Ğ–Ğ•ĞĞ©Ğ˜ĞĞ« 35-60 (draft):" 
          find articles/women-35-60 -type f -name "*.md" 2>/dev/null | head -3 | while read f; do
            DIR=$(dirname "$f")
            REL_DIR=$(echo "$DIR" | sed 's|^articles/||')
            echo "   âœ… $REL_DIR/$(basename "$f")"
          done
          echo ""
          
          echo "2ï¸âƒ£  PUBLISHED (ÑƒĞ¶Ğµ Ğ¾Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ¾Ğ²Ğ°Ğ½Ğ¾):"
          find articles/published -type f -name "*.md" 2>/dev/null | head -3 | while read f; do
            DIR=$(dirname "$f")
            REL_DIR=$(echo "$DIR" | sed 's|^articles/||')
            echo "   âœ… $REL_DIR/$(basename "$f")"
          done
          echo ""

      - name: ğŸš€ Generate RSS Feed (FULL mode)
        if: github.event.inputs.mode == 'full'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Ğ ĞµĞ¶Ğ¸Ğ¼: FULL (Ğ²ÑĞµ ÑÑ‚Ğ°Ñ‚ÑŒĞ¸)"
          echo "   Ğ’ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚: articles/women-35-60/* + articles/published/*"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          npm run feed:full
        env:
          BASE_URL: https://dzen-livid.vercel.app
          GITHUB_REPOSITORY: crosspostly/dzen

      - name: ğŸš€ Generate RSS Feed (INCREMENTAL mode)
        if: github.event.inputs.mode == 'incremental'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Ğ ĞµĞ¶Ğ¸Ğ¼: INCREMENTAL (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½Ğ¾Ğ²Ñ‹Ğµ)"
          echo "   Ğ’ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚: articles/women-35-60/* (Ğ¸ÑĞºĞ»ÑÑ‡Ğ°Ñ published)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          npm run feed:incremental
        env:
          BASE_URL: https://dzen-livid.vercel.app
          GITHUB_REPOSITORY: crosspostly/dzen

      - name: âœ… Verify feed.xml created
        id: verify
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          if [ -f "public/feed.xml" ]; then
            echo "âœ… Feed ÑĞ¾Ğ·Ğ´Ğ°Ğ½ Ğ² public/feed.xml"
            echo "status=feed-created" >> $GITHUB_OUTPUT
            echo ""
            echo "ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ñ„Ğ°Ğ¹Ğ»Ğ°:"
            ls -lh public/feed.xml
            echo "   Ğ Ğ°Ğ·Ğ¼ĞµÑ€: $(stat --format=%s public/feed.xml 2>/dev/null || stat -f%z public/feed.xml) bytes"
            echo ""
            
            echo "ğŸ“ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğ³Ğ¾ (Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ 1000 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²):"
            head -c 1000 public/feed.xml
            echo ""
            echo ""
            
            echo "ğŸ”— ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° URL'Ğ¾Ğ² Ğ½Ğ° Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ:"
            grep -o 'enclosure url="[^"]*' public/feed.xml | head -5 | while read line; do
              echo "   $line"
            done
            echo ""
            
            echo "ğŸ“Š ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑÑ‚Ğ°Ñ‚ĞµĞ¹ Ğ² RSS:"
            ITEM_COUNT=$(grep -c "<item>" public/feed.xml)
            echo "   Ğ’ÑĞµĞ³Ğ¾ ÑÑ‚Ğ°Ñ‚ĞµĞ¹: $ITEM_COUNT"
            echo ""
          else
            echo "âŒ Feed ĞĞ• ÑĞ¾Ğ·Ğ´Ğ°Ğ½! ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ Ğ»Ğ¾Ğ³Ğ¸ Ğ²Ñ‹ÑˆĞµ."
            echo "status=no-feed" >> $GITHUB_OUTPUT
            echo ""
            echo "ğŸ” Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ public/:"
            ls -la public/ 2>/dev/null || echo "ĞŸĞ°Ğ¿ĞºĞ° public Ğ½Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚"
          fi

      - name: ğŸ“¤ Commit and push changes
        if: steps.verify.outputs.status == 'feed-created'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¤ Ğ—Ğ°ĞºÑ€ĞµĞ¿Ğ»ÑĞµĞ¼ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ² Git"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Actions"
          
          # Force add feed.xml (ignoring .gitignore if needed)
          git add -f public/feed.xml
          echo "âœ… Feed.xml Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ² Ğ¸Ğ½Ğ´ĞµĞºÑ"
          echo ""
          
          # Check if there are actual changes
          if git diff --cached --quiet; then
            echo "â„¹ï¸  ĞĞµÑ‚ Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ°"
          else
            echo "ğŸ“ ĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ¸Ğ¼ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ..."
            git commit -m "chore: Update RSS feed [${{ github.event.inputs.mode }} mode] - $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            echo "âœ… ĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ½"
            echo ""
            
            echo "ğŸš€ ĞŸÑƒÑˆĞ¸Ğ¼ Ğ² main..."
            git push origin main || {
              echo "âš ï¸  First push failed, syncing with remote first..."
              git fetch origin main
              git rebase origin/main
              git push origin main
            }
            echo "âœ… Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑˆĞµĞ½Ğ¾!"
          fi
          echo ""

      - name: ğŸ“Š Final Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Ğ˜Ğ¢ĞĞ“ĞĞ’Ğ«Ğ™ ĞĞ¢Ğ§Ğ•Ğ¢"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“‹ ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸:"
          echo "   Ğ ĞµĞ¶Ğ¸Ğ¼: ${{ github.event.inputs.mode }}"
          echo "   Feed ÑĞ¾Ğ·Ğ´Ğ°Ğ½: $([ '${{ steps.verify.outputs.status }}' = 'feed-created' ] && echo 'âœ… Ğ”Ğ' || echo 'âŒ ĞĞ•Ğ¢')"
          echo ""
          echo "ğŸ“ Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ñ‹ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ¾Ğ²:"
          echo "   ğŸ”„ full       - Ğ ĞµĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ²ÑĞµ ÑÑ‚Ğ°Ñ‚ÑŒĞ¸ (articles/women-35-60 + published)"
          echo "   ğŸ“§ incremental - Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½Ğ¾Ğ²Ñ‹Ğµ ÑÑ‚Ğ°Ñ‚ÑŒĞ¸ (articles/women-35-60, Ğ±ĞµĞ· published)"
          echo ""
          echo "ğŸ”— RSS Feed URL:"
          echo "   https://raw.githubusercontent.com/crosspostly/dzen/main/public/feed.xml"
          echo ""
