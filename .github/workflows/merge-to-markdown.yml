name: Merge All Files to Markdown

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  merge-files:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        pip install python-docx openpyxl pandas
        
    - name: Create merge script
      run: |
        cat > merge_to_markdown.py << 'EOF'
        import os
        import sys
        from pathlib import Path
        from docx import Document
        import pandas as pd
        
        def read_txt_file(filepath):
            """Ð§Ð¸Ñ‚Ð°ÐµÑ‚ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»"""
            try:
                with open(filepath, 'r', encoding='utf-8') as f:
                    return f.read()
            except:
                return f"ÐžÑˆÐ¸Ð±ÐºÐ° Ñ‡Ñ‚ÐµÐ½Ð¸Ñ Ñ„Ð°Ð¹Ð»Ð° {filepath}"
        
        def read_docx_file(filepath):
            """Ð§Ð¸Ñ‚Ð°ÐµÑ‚ DOCX Ñ„Ð°Ð¹Ð»"""
            try:
                doc = Document(filepath)
                text = []
                for para in doc.paragraphs:
                    text.append(para.text)
                return '\n'.join(text)
            except Exception as e:
                return f"ÐžÑˆÐ¸Ð±ÐºÐ° Ñ‡Ñ‚ÐµÐ½Ð¸Ñ DOCX {filepath}: {str(e)}"
        
        def read_xlsx_file(filepath):
            """Ð§Ð¸Ñ‚Ð°ÐµÑ‚ XLSX Ñ„Ð°Ð¹Ð»"""
            try:
                excel_file = pd.ExcelFile(filepath)
                result = []
                for sheet_name in excel_file.sheet_names:
                    df = pd.read_excel(filepath, sheet_name=sheet_name)
                    result.append(f"### Ð›Ð¸ÑÑ‚: {sheet_name}\n")
                    result.append(df.to_markdown(index=False))
                    result.append("\n")
                return '\n'.join(result)
            except Exception as e:
                return f"ÐžÑˆÐ¸Ð±ÐºÐ° Ñ‡Ñ‚ÐµÐ½Ð¸Ñ XLSX {filepath}: {str(e)}"
        
        def main():
            output = []
            output.append("# Ð‘Ð°Ð·Ð° Ð—Ð½Ð°Ð½Ð¸Ð¹ Ð´Ð»Ñ Ð“ÐµÐ½ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð° Ð¡Ñ‚Ð°Ñ‚ÐµÐ¹ Ð¯Ð½Ð´ÐµÐºÑ Ð”Ð·ÐµÐ½\n")
            output.append(f"Ð¡Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸\n\n")
            output.append("---\n\n")
            
            # ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð²ÑÐµ Ð¿Ð°Ð¿ÐºÐ¸
            for root, dirs, files in os.walk('.'):
                # ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ð¿Ð°Ð¿ÐºÐ¸
                if '.git' in root or '__pycache__' in root:
                    continue
                    
                if files:
                    folder_name = os.path.basename(root) if root != '.' else 'ÐšÐ¾Ñ€Ð½ÐµÐ²Ð°Ñ Ð¿Ð°Ð¿ÐºÐ°'
                    output.append(f"## ðŸ“ {folder_name}\n\n")
                    
                    for file in sorted(files):
                        if file.endswith(('.txt', '.docx', '.xlsx')):
                            filepath = os.path.join(root, file)
                            output.append(f"### ðŸ“„ {file}\n\n")
                            
                            if file.endswith('.txt'):
                                content = read_txt_file(filepath)
                            elif file.endswith('.docx'):
                                content = read_docx_file(filepath)
                            elif file.endswith('.xlsx'):
                                content = read_xlsx_file(filepath)
                            else:
                                content = "ÐÐµÐ¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÐ¼Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚"
                            
                            output.append(f"```\n{content}\n```\n\n")
                            output.append("---\n\n")
            
            # Ð—Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚
            with open('KNOWLEDGE_BASE.md', 'w', encoding='utf-8') as f:
                f.write(''.join(output))
            
            print("âœ… Ð¤Ð°Ð¹Ð» KNOWLEDGE_BASE.md ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½!")
        
        if __name__ == '__main__':
            main()
        EOF
        
    - name: Run merge script
      run: python merge_to_markdown.py
      
    - name: Commit and push
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add KNOWLEDGE_BASE.md
        git diff --quiet && git diff --staged --quiet || (git commit -m "ðŸ¤– Auto-update: Merge all files to KNOWLEDGE_BASE.md" && git push)
