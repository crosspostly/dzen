name: üìπ Auto Video Generation

on:
  push:
    paths:
      - 'articles/**/*.md'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-videos:
    runs-on: ubuntu-latest
    # Avoid infinite loops if the bot pushes changes
    if: github.actor != 'github-actions[bot]'
    timeout-minutes: 60
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üîß Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg build-essential libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev

      - name: üì¶ Install JS Dependencies
        run: |
          npm install
          npx playwright install chromium --with-deps

      - name: üé¨ Generate Missing Videos
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        timeout-minutes: 55
        run: |
          set -e  # Exit on any error
          echo "üîç SYSTEM DIAGNOSTICS:"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚úì Node: $(node --version)"
          echo "‚úì NPM: $(npm --version)"
          echo "‚úì FFmpeg: $(ffmpeg -version 2>&1 | head -1 || echo 'MISSING')"
          echo "‚úì Playwright: $(npx playwright --version)"
          echo "‚úì API Key: $([ -n \"$GEMINI_API_KEY\" ] && echo 'SET' || echo 'MISSING')"
          echo "‚úì Script exists: $([ -f promo_video/src/cli.ts ] && echo 'YES' || echo 'NO')"
          echo "‚úì Node memory: $(node -e 'console.log(Math.round(require(\"os\").totalmem() / 1024 / 1024 / 1024)) + \"GB\"')"
          echo ""
          
          echo "üîç Scanning for articles without videos..."
          FILES=$(find articles -name "*.md" ! -name "REPORT.md" -type f | head -20)
          FILE_COUNT=$(echo "$FILES" | wc -l)
          echo "Found $FILE_COUNT articles to process"
          echo ""
          
          SUCCESS=0
          FAILED=0
          SKIPPED=0
          
          for file in $FILES; do
            [ -z "$file" ] && continue
            
            dir=$(dirname "$file")
            base=$(basename "$file" .md)
            video_file="$dir/$base.mp4"
            
            if [ ! -f "$video_file" ]; then
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo "üìπ Processing: $file"
              
              # Wrap CLI execution with error handling
              if timeout 600 npx tsx promo_video/src/cli.ts "$file" 2>&1; then
                echo "‚úÖ CLI executed successfully"
                
                # Check if video was actually created
                if [ -f "$video_file" ]; then
                  size=$(stat -c%s "$video_file" 2>/dev/null || echo 0)
                  size_mb=$((size / 1024 / 1024))
                  echo "‚úì Video created: ${size_mb}MB"
                  
                  # Size check (25MB limit)
                  if [ $size -gt $((25 * 1024 * 1024)) ]; then
                    echo "‚ö†Ô∏è Video too large, removing..."
                    rm "$video_file"
                    ((FAILED++))
                  else
                    echo "‚úÖ Video OK (${size_mb}MB < 25MB)"
                    ((SUCCESS++))
                  fi
                else
                  echo "‚ö†Ô∏è Video file not created: $video_file"
                  ((FAILED++))
                fi
              else
                EXIT_CODE=$?
                echo "‚ùå CLI failed (exit: $EXIT_CODE)"
                echo "üìã Trying to read error file..."
                [ -f error.log ] && cat error.log || echo "No error.log found"
                ((FAILED++))
              fi
            else
              echo "‚è≠Ô∏è Skipping (already exists): $base.mp4"
              ((SKIPPED++))
            fi
          done
          
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìä SUMMARY:"
          echo "‚úÖ Success: $SUCCESS"
          echo "‚ùå Failed: $FAILED"
          echo "‚è≠Ô∏è Skipped: $SKIPPED"
          echo ""
          
          # Only fail if we had actual errors AND no successes
          if [ $FAILED -gt 0 ] && [ $SUCCESS -eq 0 ]; then
            echo "‚ö†Ô∏è Video generation had failures but no successes"
            # Don't exit with error yet, let's try to push what we have
          fi

      - name: üîê Git Config
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: üì§ Push New Videos
        run: |
          echo "üìã Git status:"
          git status
          echo ""
          
          echo "üìù Staging video files..."
          git add articles/**/*.mp4 2>/dev/null || echo "No .mp4 files to add"
          git add articles/**/.assets_*/manifest.json 2>/dev/null || echo "No manifest files to add"
          
          echo "üìã Files to commit:"
          git diff --cached --name-only
          echo ""
          
          if ! git diff --cached --quiet; then
            echo "‚úÖ Committing changes..."
            git commit -m "ü§ñ Auto-generated promo videos [skip ci]"
            git push
          else
            echo "‚ÑπÔ∏è No changes to commit"
          fi
