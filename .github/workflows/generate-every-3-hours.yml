name: ZenMaster v2.0 - Generate Every 3 Hours

on:
  schedule:
    # Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÐºÐ°Ð¶Ð´Ñ‹Ðµ 3 Ñ‡Ð°ÑÐ°: 00:00, 03:00, 06:00, 09:00, 12:00, 15:00, 18:00, 21:00 UTC
    - cron: '0 0,3,6,9,12,15,18,21 * * *'
  workflow_dispatch:

jobs:
  generate-article:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: feature/zenmaster-v2.0
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Select random theme
        id: theme_selector
        run: |
          # ÐœÐ°ÑÑÐ¸Ð² Ñ‚ÐµÐ¼ Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸
          themes=(
            "Ð¯ Ð¼Ð½Ð¾Ð³Ð¾ Ð»ÐµÑ‚ Ð½Ðµ Ð·Ð½Ð°Ð»Ð° Ð¿Ñ€Ð°Ð²Ð´Ñƒ Ð¾Ð± Ð¾Ñ‚Ñ†Ðµ"
            "ÐžÐ½Ð¸ Ð½Ðµ Ð²ÐµÑ€Ð¸Ð»Ð¸ Ð² Ð¼Ð¾ÑŽ Ð¼ÐµÑ‡Ñ‚Ñƒ"
            "ÐžÐ´Ð¸Ð½ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€ Ð²ÑÑ‘ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»"
            "Ð¯ ÑƒÑˆÐ»Ð° Ð¼Ð¾Ð»Ñ‡Ð° Ð¸ Ð½Ðµ Ð¿Ð¾Ð¶Ð°Ð»ÐµÐ»Ð°"
            "20 Ð»ÐµÑ‚ Ñ Ñ‚ÐµÑ€Ð¿ÐµÐ»Ð° ÑÑ‚Ð¾ Ð¼Ð¾Ð»Ñ‡Ð°"
            "Ð¡Ð¾ÑÐµÐ´ÐºÐ° Ð¿Ñ€Ð¸Ð½ÐµÑÐ»Ð° Ð¿Ð¸Ñ€Ð¾Ð³ Ð¸ Ñ€Ð°ÑÑÐºÐ°Ð·Ð°Ð»Ð° Ñ‚Ð°Ð¹Ð½Ñƒ"
            "Ð¯ Ð¾Ñ‚ÐºÑ€Ñ‹Ð»Ð° Ð¿Ð¸ÑÑŒÐ¼Ð¾ Ð¸ Ð¿Ð¾Ð½ÑÐ»Ð°, Ñ‡Ñ‚Ð¾ Ð¶Ð¸Ð²Ñƒ Ð½Ðµ ÑÐ²Ð¾ÐµÐ¹ Ð¶Ð¸Ð·Ð½ÑŒÑŽ"
            "Ð”Ð¾Ñ‡ÑŒ ÑÐ¿Ñ€Ð¾ÑÐ¸Ð»Ð° Ð¼ÐµÐ½Ñ Ð¿Ñ€ÑÐ¼Ð¾ Ð¸ Ñ Ð½Ðµ ÑÐ¼Ð¾Ð³Ð»Ð° ÑÐ¾Ð²Ñ€Ð°Ñ‚ÑŒ"
            "ÐœÑ‹ Ð½Ðµ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð°Ñ€Ð¸Ð²Ð°Ð»Ð¸ Ð¼ÐµÑÑÑ†Ñ‹, Ð° Ð¿Ð¾Ñ‚Ð¾Ð¼ Ð¾Ð½Ð° Ð¿Ñ€Ð¸ÑˆÐ»Ð° Ð²ÐµÑ‡ÐµÑ€Ð¾Ð¼"
            "Ð¯ Ð¿Ñ€Ð¸ÐµÑ…Ð°Ð»Ð° Ð½Ð° Ð¿ÑÑ‚ÑŒ Ð¼Ð¸Ð½ÑƒÑ‚ Ð¸ ÑƒÐµÑ…Ð°Ð»Ð° Ð´Ñ€ÑƒÐ³Ð¸Ð¼ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ¾Ð¼"
          )
          
          # Ð¡Ð»ÑƒÑ‡Ð°Ð¹Ð½Ð°Ñ Ñ‚ÐµÐ¼Ð°
          RANDOM_THEME=${themes[$((RANDOM % ${#themes[@]}))]}
          
          # Ð¡Ð»ÑƒÑ‡Ð°Ð¹Ð½Ñ‹Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹
          angles=("confession" "scandal" "observer")
          emotions=("triumph" "guilt" "shame" "liberation" "anger")
          
          ANGLE=${angles[$((RANDOM % ${#angles[@]}))]}
          EMOTION=${emotions[$((RANDOM % ${#emotions[@]}))]}
          
          echo "theme=$RANDOM_THEME" >> $GITHUB_OUTPUT
          echo "angle=$ANGLE" >> $GITHUB_OUTPUT
          echo "emotion=$EMOTION" >> $GITHUB_OUTPUT
          echo "audience=Women 35-60" >> $GITHUB_OUTPUT
          
          echo "ðŸ“ Selected theme: $RANDOM_THEME"
          echo "ðŸŽ¯ Angle: $ANGLE"
          echo "ðŸ’« Emotion: $EMOTION"
      
      - name: Generate article for Dzen Women 35-60
        run: |
          npm run generate:v2 -- \
            --dzen-channel=women-35-60 \
            --theme="${{ steps.theme_selector.outputs.theme }}"
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          API_KEY: ${{ secrets.GEMINI_API_KEY }}
      
      - name: Create output directory
        run: mkdir -p generated/articles
      
      - name: Save article metadata
        run: |
          TIMESTAMP=$(date -u +'%Y-%m-%d_%H-%M-%S')
          cat > "generated/articles/article_${TIMESTAMP}.json" << 'EOF'
          {
            "theme": "${{ steps.theme_selector.outputs.theme }}",
            "angle": "${{ steps.theme_selector.outputs.angle }}",
            "emotion": "${{ steps.theme_selector.outputs.emotion }}",
            "audience": "${{ steps.theme_selector.outputs.audience }}",
            "generatedAt": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')",
            "trigger": "scheduled-3-hour",
            "workflowRun": "${{ github.run_id }}"
          }
          EOF
          echo "âœ… Metadata saved to generated/articles/article_${TIMESTAMP}.json"
      
      - name: Commit and push
        run: |
          git config --local user.email "zenmaster-bot@github.com"
          git config --local user.name "ZenMaster Automated Bot"
          
          git add generated/
          git commit -m "ðŸŽ¬ [AUTO] Generated article: ${{ steps.theme_selector.outputs.theme }} [${{ steps.theme_selector.outputs.angle }}]" || echo "No changes to commit"
          git push origin feature/zenmaster-v2.0
      
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        if: success()
        with:
          name: generated-article-${{ github.run_id }}
          path: generated/articles/
          retention-days: 90
      
      - name: Create workflow summary
        run: |
          cat > $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸŽ¬ ZenMaster v2.0 Generation Summary - Dzen Women 35-60
          
          **Channel**: Women 35-60 (confession, triumph)
          **Theme**: ${{ steps.theme_selector.outputs.theme }}
          **Configuration**: Using DZEN_WOMEN_35_60_CONFIG
          
          **Parameters (from config)**:
          - Angle: confession
          - Emotion: triumph
          - Audience: Women 35-60
          - Model: gemini-2.5-pro (outline), gemini-2.5-flash (episodes)
          
          **Generated at**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          **Workflow ID**: ${{ github.run_id }}
          **Branch**: feature/zenmaster-v2.0
          
          ### Generated Files
          - âœ… Metadata saved
          - ðŸ“ Article generated for Dzen channel
          - ðŸ”„ Committed to branch
          - ðŸ“ Saved to: generated/dzen/women-35-60/
          
          ### Migration Status
          - âœ… Parameters moved from GitHub Variables to channel config
          - âœ… Workflow updated to use --dzen-channel parameter
          - âœ… Legacy angle/emotion/audience variables no longer needed
          
          EOF
      
      - name: On failure notification
        if: failure()
        run: |
          echo "âŒ Generation failed for theme: ${{ steps.theme_selector.outputs.theme }}"
          echo "Check workflow logs at: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
