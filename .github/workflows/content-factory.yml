name: –§–∞–±—Ä–∏–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∞—Ç–µ–π (–î–∑–µ–Ω)

on:
  schedule:
    # –ó–∞–ø—É—Å–∫ –≤ 05:00 UTC –∫–∞–∂–¥—ã–π –¥–µ–Ω—å
    - cron: '0 5 * * *'
  workflow_dispatch:
    inputs:
      count:
        description: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞—Ç–µ–π (1, 5, 10, 25, 50, 100)'
        required: true
        default: '1'
        type: choice
        options:
          - '1'
          - '5'
          - '7'
          - '10'
          - '25'
          - '50'
          - '100'
      channel:
        description: '–¢–µ–º–∞—Ç–∏–∫–∞ –∫–∞–Ω–∞–ª–∞'
        required: true
        default: 'women-35-60'
        type: choice
        options:
          - 'women-35-60'
          - 'young-moms'
          - 'men-25-40'
          - 'teens'
      images:
        description: '–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–±–ª–æ–∂–∫–∏?'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write

jobs:
  factory:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - name: üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞ (Checkout)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (Canvas)
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev
      
      - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        run: npm install
      
      - name: ‚úçÔ∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∞—Ç–µ–π
        run: |
          # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç—Ä–∏–≥–≥–µ—Ä–∞
          if [ "${{ github.event_name }}" == "schedule" ]; then
            COUNT="7"
            CHANNEL="women-35-60"
            IMAGES="true"
            echo "‚è∞ –ó–∞–ø—É—Å–∫ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é: –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (10 —Å—Ç–∞—Ç–µ–π, women-35-60, –∫–∞—Ä—Ç–∏–Ω–∫–∏)"
          else
            COUNT="${{ inputs.count }}"
            CHANNEL="${{ inputs.channel }}"
            IMAGES="${{ inputs.images }}"
            echo "üëã –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫: –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã"
          fi
          
          echo "====================================================="
          echo "üöÄ –§–∞–±—Ä–∏–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∞—á–∫–∏ —Å—Ç–∞—Ç–µ–π"
          echo "====================================================="
          echo "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:    $COUNT"
          echo "–ö–∞–Ω–∞–ª:         $CHANNEL"
          echo "–ö–∞—Ä—Ç–∏–Ω–∫–∏:      $IMAGES"
          echo "–í—ã—Ö–æ–¥ –≤:       articles/$CHANNEL/$(date +%Y-%m-%d)/"
          echo "====================================================="
          echo ""
          
          CMD="npx tsx cli.ts factory --count=$COUNT --channel=$CHANNEL"
          
          if [ "$IMAGES" = "true" ]; then
            CMD="$CMD --images"
          fi
          
          echo "–ó–∞–ø—É—Å–∫ –∫–æ–º–∞–Ω–¥—ã: $CMD"
          echo ""
          
          eval "$CMD"
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          API_KEY: ${{ secrets.GEMINI_API_KEY }}
          FINAL_CLEANUP_ENABLED: true
          CLEANUP_THRESHOLD: medium
          CLEANUP_MODEL: gemini-2.0-flash
          CLEANUP_TEMPERATURE: 0.3
          CLEANUP_MAX_RETRIES: 2

      - name: üîß –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–µ–π (Auto-restore)
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–¥—É–±–ª–∏—Ä—É–µ–º –ª–æ–≥–∏–∫—É, —á—Ç–æ–±—ã –±—ã—Ç—å —É–≤–µ—Ä–µ–Ω–Ω—ã–º–∏)
          if [ "${{ github.event_name }}" == "schedule" ]; then
            CHANNEL="women-35-60"
          else
            CHANNEL="${{ inputs.channel }}"
          fi
          
          TODAY=$(date +%Y-%m-%d)
          TARGET_DIR="articles/$CHANNEL/$TODAY"
          
          echo "====================================================="
          echo "üîß –ó–∞–ø—É—Å–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è: $TARGET_DIR"
          echo "====================================================="
          
          if [ -d "$TARGET_DIR" ]; then
            # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ .md —Ñ–∞–π–ª—ã –≤ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –ø–∞–ø–∫–µ
            FILES=$(find "$TARGET_DIR" -name "*.md" -type f)
            
            if [ -z "$FILES" ]; then
               echo "‚ö†Ô∏è –§–∞–π–ª—ã .md –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ $TARGET_DIR"
            else
               # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –≤ –ø—Ä–æ–±–µ–ª—ã –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏
               FILES_ARGS=$(echo "$FILES" | tr '\n' ' ')
               
               echo "–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤:"
               echo "$FILES"
               echo ""
               
               node scripts/restore-articles-safe.js $FILES_ARGS
            fi
          else
            echo "‚ö†Ô∏è –ü–∞–ø–∫–∞ $TARGET_DIR –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ (–≤–æ–∑–º–æ–∂–Ω–æ, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–µ —Å–æ–∑–¥–∞–ª–∞ —Ñ–∞–π–ª—ã?)"
          fi

      - name: üìä –ü–æ–¥—Å—á–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        if: always()
        run: |
          ARTICLE_COUNT=$(find ./articles -name "*.txt" 2>/dev/null | wc -l)
          IMAGE_COUNT=$(find ./articles -name "*.jpg" 2>/dev/null | xargs wc -l | tail -1 | awk '{print $1}' || find ./articles -name "*.png" 2>/dev/null | wc -l)
          
          echo ""
          echo "–ò—Ç–æ–≥–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:"
          echo "====================================================="
          echo "–°—Ç–∞—Ç–µ–π —Å–æ–∑–¥–∞–Ω–æ:   $ARTICLE_COUNT"
          echo "–ö–∞—Ä—Ç–∏–Ω–æ–∫ —Å–æ–∑–¥–∞–Ω–æ: $IMAGE_COUNT"
          echo "====================================================="
          echo ""
      
      - name: üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: articles-${{ inputs.channel || 'scheduled' }}-${{ github.run_id }}
          path: articles/
          retention-days: 90
          if-no-files-found: warn
      
      - name: üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Git
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
      
      - name: üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π (Push)
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            
            const maxRetries = 3;
            const retryDelay = 2000;
            
            async function pushWithRetry() {
              for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                  console.log(`\nüîÑ –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ ${attempt}/${maxRetries}...`);
                  
                  console.log('üì• –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è...');
                  execSync('git fetch origin ${{ github.ref_name }}', { stdio: 'inherit' });
                  
                  console.log('‚öôÔ∏è  –°–ª–∏—è–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π (Rebase)...');
                  execSync('git rebase origin/${{ github.ref_name }}', { stdio: 'inherit' });
                  
                  console.log('üìÇ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ (—Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç—å–∏)...');
                  execSync('git add articles/', { stdio: 'inherit' });
                  
                  console.log('üìä –°—Ç–∞—Ç—É—Å git –ø–æ—Å–ª–µ add:');
                  execSync('git status', { stdio: 'inherit' });
                  
                  try {
                    execSync('git diff --cached --quiet');
                    console.log('‚ö†Ô∏è  –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞');
                    return true;
                  } catch (e) {
                    // git diff –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 1, –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è - —ç—Ç–æ —Ç–æ, —á—Ç–æ –Ω–∞–º –Ω—É–∂–Ω–æ
                  }
                  
                  console.log('üíæ –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞...');
                  const timestamp = new Date().toISOString().split('T')[0];
                  let message = '';
                  const eventName = '${{ github.event_name }}';
                  
                  if (eventName === 'schedule') {
                     message = `ü§ñ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç: 10 —Å—Ç–∞—Ç–µ–π (${timestamp})`;
                  } else {
                     const channel = '${{ inputs.channel }}';
                     const count = '${{ inputs.count }}';
                     message = `üìù –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∞—Ç–µ–π: ${timestamp} - ${count} —à—Ç. (${channel})`;
                  }
                  
                  execSync(`git commit -m "${message}"`, { stdio: 'inherit' });
                  
                  console.log('üöÄ –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ GitHub...');
                  execSync('git push origin ${{ github.ref_name }}', { stdio: 'inherit' });
                  
                  console.log('‚úÖ –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
                  return true;
                  
                } catch (error) {
                  if (attempt === maxRetries) {
                    console.error(`\n‚ùå –û—à–∏–±–∫–∞ –ø–æ—Å–ª–µ ${maxRetries} –ø–æ–ø—ã—Ç–æ–∫`);
                    throw error;
                  } else {
                    console.log(`‚ö†Ô∏è  –ü–æ–ø—ã—Ç–∫–∞ ${attempt} –Ω–µ —É–¥–∞–ª–∞—Å—å. –ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ ${retryDelay}–º—Å...`);
                    try { execSync('git reset --hard HEAD', { stdio: 'pipe' }); } catch (e) {}
                    await new Promise(resolve => setTimeout(resolve, retryDelay));
                  }
                }
              }
            }
            
            await pushWithRetry();
