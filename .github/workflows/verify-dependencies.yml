name: üîß Verify Dependencies & Test Build

on:
  push:
    branches: [main]
    paths:
      - 'package.json'
      - 'package-lock.json'
  workflow_dispatch:

jobs:
  verify:
    runs-on: ubuntu-latest
    name: Verify Dependencies Installation
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üöÄ Install dependencies (clean install)
        run: |
          npm ci
          echo "‚úÖ Dependencies installed successfully"
          npm ls @google/generative-ai

      - name: ‚úÖ Verify correct packages installed
        run: |
          # Check that @google/generative-ai is installed
          if npm ls @google/generative-ai > /dev/null 2>&1; then
            echo "‚úÖ @google/generative-ai found"
          else
            echo "‚ùå @google/generative-ai NOT found"
            exit 1
          fi
          
          # Check that @google/genai is NOT installed
          if npm ls @google/genai > /dev/null 2>&1; then
            echo "‚ùå ERROR: @google/genai should NOT be installed"
            exit 1
          else
            echo "‚úÖ @google/genai correctly NOT installed"
          fi

      - name: üîç TypeScript check
        run: npx tsc --noEmit
        continue-on-error: true

      - name: ‚úÖ Summary
        run: |
          echo "========================================"
          echo "‚úÖ DEPENDENCY VERIFICATION PASSED"
          echo "========================================"
          echo ""
          echo "Installed packages:"
          npm ls --depth=0
