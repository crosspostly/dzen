name: Auto-Generate RSS Feed

on:
  push:
    paths:
      - 'articles/**/*.md'
      - 'articles/**/*.jpg'
    branches:
      - main

jobs:
  generate-feed:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: ğŸ” Check what changed
        run: |
          echo ""
          echo "======================================================"
          echo "ğŸ” Files that triggered this workflow:"
          echo "======================================================"
          git diff --name-only HEAD~1 HEAD | grep -E '\.(md|jpg)$' | head -10
          echo ""

      - name: ğŸš€ Generate RSS Feed (INCREMENTAL mode)
        run: |
          echo ""
          echo "======================================================"
          echo "ğŸš€ Generating RSS Feed (INCREMENTAL mode)"
          echo "ğŸ“ Only new articles will be added to feed"
          echo "======================================================"
          echo ""
          npm run feed:incremental
        env:
          BASE_URL: https://raw.githubusercontent.com/crosspostly/dzen/main
          GITHUB_REPOSITORY: crosspostly/dzen

      - name: âœ… Verify feed.xml
        run: |
          echo ""
          echo "======================================================"
          echo "âœ… Feed Generation Result"
          echo "======================================================"
          echo ""
          
          if [ -f "public/feed.xml" ]; then
            echo "âœ… Feed created successfully"
            echo "   ğŸ“Š Size: $(stat --format=%s public/feed.xml 2>/dev/null || stat -f%z public/feed.xml) bytes"
            echo ""
            echo "ğŸ“Š Items in feed:"
            ITEM_COUNT=$(grep -c "<item>" public/feed.xml || echo "0")
            echo "   $ITEM_COUNT articles"
            echo ""
            echo "ğŸ”— Sample image URL:"
            grep -o 'enclosure url="[^"]*' public/feed.xml | head -1 | sed 's/enclosure url="/   /'
            echo ""
          else
            echo "âŒ Feed was NOT created!"
            exit 1
          fi

      - name: ğŸ“¤ Commit RSS feed
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Actions"
          
          git add -f public/feed.xml
          
          if ! git diff --cached --quiet; then
            echo "ğŸ“ Committing RSS feed..."
            git commit -m "chore: auto-update RSS feed [$(date -u +'%Y-%m-%d %H:%M:%S UTC')]"
            
            echo "ğŸš€ Pushing..."
            git push origin main || {
              git fetch origin main
              git rebase origin/main
              git push origin main
            }
            echo "âœ… Done!"
          else
            echo "â„¹ï¸ No changes in feed"
          fi
          echo ""
