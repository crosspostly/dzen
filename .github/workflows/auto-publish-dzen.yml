name: Auto-Publish to Dzen Every 3 Hours

on:
  schedule:
    - cron: '0 */3 * * *'
  workflow_dispatch:

jobs:
  publish:
    runs-on: windows-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Check feed.xml
        run: |
          Write-Host "ğŸ” Checking feed.xml..."
          if (Test-Path "public/feed.xml") {
            Write-Host "âœ… feed.xml found at: public/feed.xml"
            $itemCount = (Get-Content "public/feed.xml" | Select-String "<item>" | Measure-Object).Count
            Write-Host "   Articles: $itemCount"
          } else {
            Write-Host "âŒ feed.xml not found!"
            exit 1
          }
        shell: pwsh
      
      - name: Check GitHub Secret
        run: |
          Write-Host "ğŸ” Checking DZEN_COOKIES_JSON secret..."
          if ("${{ secrets.DZEN_COOKIES_JSON }}" -ne "") {
            Write-Host "âœ… Secret found! Size: $("${{ secrets.DZEN_COOKIES_JSON }}".Length) characters"
          } else {
            Write-Host "âŒ ERROR: Secret DZEN_COOKIES_JSON not found!"
            Write-Host "Add it to: Settings > Secrets and variables > Actions"
            Write-Host "Name: DZEN_COOKIES_JSON"
            Write-Host "Value: (your JSON cookies)"
            exit 1
          }
        shell: pwsh
      
      - name: Install dependencies
        run: |
          cd "!posts\\PRODUCTION_READY"
          npm install
        shell: pwsh
        continue-on-error: true
      
      - name: Install Playwright
        run: |
          cd "!posts\\PRODUCTION_READY"
          npx playwright install chromium
        shell: pwsh
        continue-on-error: true
      
      - name: Run auto-publisher
        env:
          CI: true
          DZEN_COOKIES_JSON: ${{ secrets.DZEN_COOKIES_JSON }}
        run: |
          Write-Host "ğŸ¤– Starting auto-publisher..."
          Write-Host "Feed location: public/feed.xml"
          Write-Host "Cookies from: Environment variable (DZEN_COOKIES_JSON)"
          Write-Host ""
          
          cd "!posts\\PRODUCTION_READY"
          node src/main.js
        shell: pwsh
        continue-on-error: true
      
      - name: Commit and push
        run: |
          Write-Host "ğŸ“¤ Committing changes..."
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          git add published_articles.txt 2>/dev/null || Write-Host "No changes to commit"
          git commit -m "ğŸ¤– Auto-publish: Article published" --allow-empty 2>/dev/null || Write-Host "Nothing to commit"
          git push 2>/dev/null || Write-Host "Push failed"
          Write-Host "âœ… Done"
        shell: pwsh
        continue-on-error: true
      
      - name: Summary
        run: |
          Write-Host ""
          Write-Host "ğŸ¤– AUTO-PUBLISHER WORKFLOW COMPLETED" -ForegroundColor Green
          Write-Host ""
          Write-Host "ğŸ“Š What happened:"
          Write-Host "   âœ… Checked feed.xml at: public/feed.xml"
          Write-Host "   âœ… Loaded cookies from: DZEN_COOKIES_JSON secret"
          Write-Host "   âœ… Ran publisher: !posts/PRODUCTION_READY/src/main.js"
          Write-Host "   âœ… Committed results to: published_articles.txt"
          Write-Host ""
          Write-Host "ğŸ” Security:"
          Write-Host "   âœ… No cookies in files"
          Write-Host "   âœ… No credentials in logs"
          Write-Host "   âœ… Env vars only (encrypted)"
          Write-Host ""
        shell: pwsh
        continue-on-error: true
