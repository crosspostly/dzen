name: ğŸ¤– Auto-Publish to Dzen Every 3 Hours

on:
  schedule:
    - cron: '0 */3 * * *'  # Every 3 hours
  workflow_dispatch:        # Manual trigger

jobs:
  publish:
    runs-on: ubuntu-latest  # Use Ubuntu (faster, cheaper than Windows)
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: ğŸ” Validate GitHub Secret (DZEN_COOKIES_JSON)
        run: |
          if [ -z "${{ secrets.DZEN_COOKIES_JSON }}" ]; then
            echo "âŒ ERROR: Secret 'DZEN_COOKIES_JSON' not found!"
            echo ""
            echo "ğŸ“‹ How to add the secret:"
            echo "1. Go to: Settings â†’ Secrets and variables â†’ Actions"
            echo "2. Click 'New repository secret'"
            echo "3. Name: DZEN_COOKIES_JSON"
            echo "4. Value: (paste your cookies JSON)"
            echo ""
            exit 1
          fi
          
          SECRET_SIZE=${#DZEN_COOKIES_JSON}
          echo "âœ… Secret 'DZEN_COOKIES_JSON' found! Size: $SECRET_SIZE characters"
        env:
          DZEN_COOKIES_JSON: ${{ secrets.DZEN_COOKIES_JSON }}
      
      - name: ğŸ“„ Check feed.xml exists
        run: |
          echo "ğŸ” Checking feed.xml..."
          if [ -f "public/feed.xml" ]; then
            ITEM_COUNT=$(grep -c "<item>" "public/feed.xml" || echo "0")
            echo "âœ… feed.xml found in /public"
            echo "   ğŸ“„ Articles in feed: $ITEM_COUNT"
          else
            echo "âŒ ERROR: feed.xml not found at /public/feed.xml"
            exit 1
          fi
      
      - name: ğŸ“‹ Install dependencies
        run: |
          echo "ğŸ“Š Installing npm packages..."
          npm install 2>&1 | tail -10
          echo "âœ… Dependencies installed"
        continue-on-error: false
      
      - name: ğŸ¥ Install Playwright
        run: |
          echo "ğŸ¥ Installing Playwright browsers..."
          npx playwright install chromium --with-deps 2>&1 | tail -10
          echo "âœ… Playwright installed"
        continue-on-error: false
      
      - name: ğŸ¤– Run auto-publisher
        id: publisher
        env:
          CI: true
          HEADLESS: true
          DZEN_COOKIES_JSON: ${{ secrets.DZEN_COOKIES_JSON }}
        run: |
          echo "========================================"
          echo "ğŸ¤– DZEN AUTO-PUBLISHER STARTING"
          echo "========================================"
          echo ""
          
          # Run the auto-publisher
          timeout 300 node !posts/zen_auto_publisher.js 2>&1
          PUBLISHER_EXIT=$?
          
          echo ""
          echo "Exit code: $PUBLISHER_EXIT"
          echo "publisher_status=$PUBLISHER_EXIT" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: ğŸ“„ Check results
        if: always()
        run: |
          echo "========================================"
          echo "ğŸ“„ WORKFLOW RESULTS"
          echo "========================================"
          echo ""
          
          if [ -f "!posts/PRODUCTION_READY/published_articles.txt" ]; then
            TOTAL_PUBLISHED=$(wc -l < "!posts/PRODUCTION_READY/published_articles.txt" || echo "0")
            echo "âœ… Publication history exists"
            echo "   Total articles published: $TOTAL_PUBLISHED"
            echo ""
            echo "ğŸ“‹ Last 3 published articles:"
            tail -3 "!posts/PRODUCTION_READY/published_articles.txt" | sed 's/^/   /'
          else
            echo "â„¹ï¸ No articles published yet"
          fi
          
          echo ""
          if [ ${{ steps.publisher.outputs.publisher_status }} -eq 0 ]; then
            echo "âœ… Publisher completed successfully!"
          else
            echo "âš ï¸ Publisher completed with warnings or errors"
          fi
      
      - name: ğŸ“¤ Commit and push updates
        if: always()
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "GitHub Actions Bot"
          
          echo "ğŸ“¤ Preparing to commit..."
          
          # Add changes
          git add "!posts/PRODUCTION_READY/published_articles.txt" 2>/dev/null || true
          git add "publish-*.log" 2>/dev/null || true
          
          # Check if there's anything to commit
          if git diff --cached --quiet; then
            echo "â„¹ï¸ Nothing to commit"
          else
            echo "ğŸ“ Committing changes..."
            git commit -m "ğŸ¤– Auto-publish: $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)" 2>&1 | tail -5
            
            echo "ğŸ“¤ Pushing to repository..."
            git push 2>&1 | tail -5
            echo "âœ… Successfully pushed!"
          fi
        continue-on-error: true
      
      - name: ğŸ“‹ Summary
        if: always()
        run: |
          echo ""
          echo "â•“â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•›"
          echo "â•‘  ğŸ¤– AUTO-PUBLISHER WORKFLOW SUMMARY   â•‘"
          echo "â•™â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•œ"
          echo ""
          echo "âœ… Completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "ğŸ“‹ What happened:"
          echo "   âœ… Validated DZEN_COOKIES_JSON secret"
          echo "   âœ… Checked feed.xml in /public"
          echo "   âœ… Installed dependencies"
          echo "   âœ… Installed Playwright browsers"
          echo "   âœ… Ran auto-publisher"
          echo "   âœ… Committed results"
          echo ""
          echo "ğŸ” Security:"
          echo "   âœ… Cookies from GitHub Secrets (AES-256 encrypted)"
          echo "   âœ… Passed via environment variable"
          echo "   âœ… Masked in logs (GitHub automatic)"
          echo "   âœ… No credentials in repository"
          echo ""
          echo "ğŸ“† Next steps:"
          echo "   â€¢ Check 'Actions' tab for detailed logs"
          echo "   â€¢ View 'published_articles.txt' for history"
          echo "   â€¢ If errors: Check logs and update selectors"
          echo ""
          echo "â° Next run: In 3 hours (or manual trigger)"
          echo ""
