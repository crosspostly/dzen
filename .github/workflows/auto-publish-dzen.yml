name: ğŸ¤– Auto-Publish to Dzen Every 3 Hours

concurrency:
  group: push-to-main
  cancel-in-progress: false

on:
  schedule:
    - cron: '0 */3 * * *'  # Every 3 hours
  workflow_dispatch:        # Manual trigger
    inputs:
      dry_run:
        description: 'Test run without publishing'
        required: false
        type: boolean
        default: false
      verbose:
        description: 'Enable verbose logging'
        required: false
        type: boolean
        default: false

jobs:
  publish:
    runs-on: ubuntu-latest  # Use Ubuntu (faster, cheaper than Windows)
    timeout-minutes: 120  # 2 Ñ‡Ğ°ÑĞ° Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼
    permissions:
      contents: write  # For push to repository
      actions: read    # For reading workflow status
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ” Validate GitHub Secret (DZEN_COOKIES_JSON)
        run: |
          if [ -z "${{ secrets.DZEN_COOKIES_JSON }}" ]; then
            echo "âŒ ERROR: Secret 'DZEN_COOKIES_JSON' not found!"
            echo ""
            echo "ğŸ“‹ How to add the secret:"
            echo "1. Go to: Settings â†’ Secrets and variables â†’ Actions"
            echo "2. Click 'New repository secret'"
            echo "3. Name: DZEN_COOKIES_JSON"
            echo "4. Value: (paste your cookies JSON)"
            echo ""
            echo "ğŸ“– How to get cookies:"
            echo "1. Open https://dzen.ru in your browser"
            echo "2. Log in with your account"
            echo "3. Open DevTools (F12) â†’ Application â†’ Cookies â†’ dzen.ru"
            echo "4. Export as JSON or copy manually"
            exit 1
          fi
          
          SECRET_SIZE=${#DZEN_COOKIES_JSON}
          echo "âœ… Secret 'DZEN_COOKIES_JSON' found! Size: $SECRET_SIZE characters"
          
          # Validate JSON format
          if echo "$DZEN_COOKIES_JSON" | python3 -m json.tool > /dev/null 2>&1; then
            echo "âœ… Valid JSON format"
          else
            echo "âš ï¸  Warning: Cookies may not be valid JSON (might be single object)"
          fi
        env:
          DZEN_COOKIES_JSON: ${{ secrets.DZEN_COOKIES_JSON }}
      
      - name: ğŸ“„ Check feed.xml exists
        run: |
          echo "ğŸ” Checking feed.xml..."
          if [ -f "public/feed.xml" ]; then
            ITEM_COUNT=$(grep -c "<item>" "public/feed.xml" || echo "0")
            echo "âœ… feed.xml found in /public"
            echo "   ğŸ“Š Articles in feed: $ITEM_COUNT"
            echo "   ğŸ“¦ File size: $(wc -c < "public/feed.xml") bytes"
          else
            echo "âŒ ERROR: feed.xml not found at /public/feed.xml"
            echo "ğŸ“ Available files:"
            ls -la public/ 2>/dev/null || echo "   /public directory not found"
            exit 1
          fi
      
      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¥ Installing npm packages..."
          npm ci
          echo "âœ… Dependencies installed"
      
      - name: ğŸ¬ Install Playwright
        run: |
          echo "ğŸ¬ Installing Playwright browsers..."
          npx playwright install chromium --with-deps
          echo "âœ… Playwright installed"
      
      - name: ğŸ¤– Run auto-publisher
        id: publisher
        env:
          CI: true
          HEADLESS: true
          DRY_RUN: ${{ github.event.inputs.dry_run || false }}
          VERBOSE: ${{ github.event.inputs.verbose || false }}
          DZEN_COOKIES_JSON: ${{ secrets.DZEN_COOKIES_JSON }}
        run: |
          echo "========================================"
          echo "ğŸ¤– DZEN AUTO-PUBLISHER STARTING"
          echo "========================================"
          echo "Dry Run: $DRY_RUN"
          echo "Verbose: $VERBOSE"
          echo ""
          
          # Run the publisher script with timeout
          if [ "$VERBOSE" = "true" ]; then
            timeout 300 npx tsx scripts/publish-dzen.ts --verbose 2>&1 | tee publish.log
          else
            timeout 300 npx tsx scripts/publish-dzen.ts 2>&1 | tee publish.log
          fi
          PUBLISHER_EXIT=$?
          
          echo ""
          echo "Exit code: $PUBLISHER_EXIT"
          echo "publisher_status=$PUBLISHER_EXIT" >> $GITHUB_OUTPUT
          
          # Save log with timestamp
          mv publish.log "publish-$(date +%s).log" || true
          exit $PUBLISHER_EXIT
        continue-on-error: true
      
      - name: ğŸ“Š Check results
        if: always()
        run: |
          echo "========================================"
          echo "ğŸ“Š WORKFLOW RESULTS"
          echo "========================================"
          
          HISTORY_FILE="!posts/PRODUCTION_READY/published_articles.txt"
          
          if [ -f "$HISTORY_FILE" ]; then
            TOTAL_PUBLISHED=$(wc -l < "$HISTORY_FILE" || echo "0")
            echo "âœ… Publication history exists"
            echo "   Total articles published: $TOTAL_PUBLISHED"
            echo ""
            echo "ğŸ“‹ Last 3 published articles:"
            tail -3 "$HISTORY_FILE" | sed 's/^/   /'
          else
            echo "â„¹ï¸  No articles published yet"
          fi
          
          echo ""
          if [ "${{ steps.publisher.outputs.publisher_status }}" = "0" ]; then
            echo "âœ… Publisher completed successfully!"
          else
            echo "âš ï¸  Publisher completed with warnings or errors"
          fi
      
      - name: ğŸ’¾ Commit and push updates
        if: github.event.inputs.dry_run != 'true'
        run: |
          set -e  # Exit on first error
          
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "GitHub Actions Bot"
          
          echo "ğŸ“¤ Preparing to commit history and logs..."
          
          # Add history file
          git add "!posts/PRODUCTION_READY/published_articles.txt" 2>/dev/null || true
          
          # Add logs if they exist
          git add "publish-*.log" 2>/dev/null || true
          
          # Check if there's anything to commit
          if git diff --cached --quiet; then
            echo "â„¹ï¸  No changes to commit"
            exit 0
          fi
          
          echo "ğŸ“ Committing changes..."
          git commit -m "ğŸ¤– Auto-publish: $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)" || {
            echo "âš ï¸  Commit failed, continuing..."
            exit 0
          }
          
          # Improved retry logic
          MAX_RETRIES=5
          RETRY_COUNT=0
          PUSH_SUCCESS=false
          
          while [ "$RETRY_COUNT" -lt "$MAX_RETRIES" ]; do
            if [ "$RETRY_COUNT" -gt 0 ]; then
              # Exponential backoff: 2^retry seconds
              DELAY=$((2 ** RETRY_COUNT))
              echo "â³ Retry $RETRY_COUNT/$MAX_RETRIES: waiting ${DELAY}s..."
              sleep "$DELAY"
            fi
            
            # Try pulling latest changes with rebase
            echo "ğŸ“¥ Pulling latest changes (attempt $((RETRY_COUNT + 1)))..."
            if git pull --rebase origin main 2>&1; then
              echo "âœ… Pull successful"
            else
              echo "âš ï¸  Rebase failed, trying merge..."
              git rebase --abort 2>/dev/null || true
              if ! git pull origin main 2>&1; then
                echo "âš ï¸  Pull failed, continuing with push anyway..."
              fi
            fi
            
            # Try pushing
            echo "ğŸ“¤ Pushing to origin (attempt $((RETRY_COUNT + 1)))..."
            if git push origin main --verbose 2>&1; then
              echo "âœ… Push successful!"
              PUSH_SUCCESS=true
              break
            else
              echo "âŒ Push failed (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
              RETRY_COUNT=$((RETRY_COUNT + 1))
            fi
          done
          
          if [ "$PUSH_SUCCESS" = "false" ]; then
            echo "âŒ Push failed after $MAX_RETRIES attempts!"
            echo ""
            echo "ğŸ“‹ Last commits:"
            git log --oneline -5
            exit 1
          fi
      
      - name: ğŸ“‹ Final Summary
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ¤– WORKFLOW COMPLETED                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Finished at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "â±ï¸  Duration: ${{ job.duration }} seconds"
          echo ""
          echo "ğŸ“Š Status Summary:"
          echo "   âœ… Validated secrets"
          echo "   âœ… Checked feed.xml"
          echo "   âœ… Installed dependencies"
          echo "   âœ… Ran auto-publisher"
          echo "   âœ… Committed and pushed updates"
          echo ""
          echo "ğŸ” Security: All sensitive data encrypted in GitHub Secrets"
          echo ""
          echo "â° Next run: In 3 hours (or manual trigger in Actions tab)"
          echo ""

  # Notification job (optional)
  notify-on-error:
    runs-on: ubuntu-latest
    needs: publish
    if: failure()
    
    steps:
      - name: ğŸ”” Notify on failure
        run: |
          echo "âš ï¸  Workflow failed!"
          echo "Check logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        continue-on-error: true
