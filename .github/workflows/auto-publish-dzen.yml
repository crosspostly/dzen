name: ğŸ¤– Auto-Publish to Dzen Every 3 Hours

concurrency:
  group: push-to-main
  cancel-in-progress: true

on:
  schedule:
    - cron: '0 */3 * * *'  # Every 3 hours
  workflow_dispatch:        # Manual trigger

jobs:
  publish:
    runs-on: ubuntu-latest  # Use Ubuntu (faster, cheaper than Windows)
    timeout-minutes: 15
    permissions:
      contents: write  # For push to repository
      actions: read    # For reading workflow status
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # Disable cache due to ! character in path - will enable after install
          
      - name: ğŸ” Validate GitHub Secret (DZEN_COOKIES_JSON)
        run: |
          if [ -z "${{ secrets.DZEN_COOKIES_JSON }}" ]; then
            echo "âŒ ERROR: Secret 'DZEN_COOKIES_JSON' not found!"
            echo ""
            echo "ğŸ“‹ How to add the secret:"
            echo "1. Go to: Settings â†’ Secrets and variables â†’ Actions"
            echo "2. Click 'New repository secret'"
            echo "3. Name: DZEN_COOKIES_JSON"
            echo "4. Value: (paste your cookies JSON)"
            echo ""
            echo "ğŸ“– How to get cookies:"
            echo "1. Open https://dzen.ru in your browser"
            echo "2. Log in with your account"
            echo "3. Open DevTools (F12) â†’ Application â†’ Cookies â†’ dzen.ru"
            echo "4. Export as JSON or copy manually"
            exit 1
          fi
          
          SECRET_SIZE=${#DZEN_COOKIES_JSON}
          echo "âœ… Secret 'DZEN_COOKIES_JSON' found! Size: $SECRET_SIZE characters"
          
          # Validate JSON format
          echo "$DZEN_COOKIES_JSON" | python3 -m json.tool > /dev/null 2>&1
          if [ $? -eq 0 ]; then
            echo "âœ… Valid JSON format"
          else
            echo "âš ï¸  Warning: Cookies may not be valid JSON (might be single object)"
          fi
        env:
          DZEN_COOKIES_JSON: ${{ secrets.DZEN_COOKIES_JSON }}
      
      - name: ğŸ“„ Check feed.xml exists
        run: |
          echo "ğŸ” Checking feed.xml..."
          if [ -f "public/feed.xml" ]; then
            ITEM_COUNT=$(grep -c "<item>" "public/feed.xml" || echo "0")
            echo "âœ… feed.xml found in /public"
            echo "   ğŸ“Š Articles in feed: $ITEM_COUNT"
            echo "   ğŸ“¦ File size: $(wc -c < "public/feed.xml") bytes"
          else
            echo "âŒ ERROR: feed.xml not found at /public/feed.xml"
            echo "ğŸ“ Available files:"
            ls -la public/ 2>/dev/null || echo "   /public directory not found"
            exit 1
          fi
      
      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¥ Installing npm packages..."
          npm ci
          echo "âœ… Dependencies installed"
      
      - name: ğŸ¬ Install Playwright
        run: |
          echo "ğŸ¬ Installing Playwright browsers..."
          npx playwright install chromium --with-deps
          echo "âœ… Playwright installed"
      
      - name: ğŸ¤– Run auto-publisher
        id: publisher
        env:
          CI: true
          HEADLESS: true
          DZEN_COOKIES_JSON: ${{ secrets.DZEN_COOKIES_JSON }}
        run: |
          echo "========================================"
          echo "ğŸ¤– DZEN AUTO-PUBLISHER STARTING"
          echo "========================================"
          
          # Run the new TypeScript script
          timeout 300 npx tsx scripts/publish-dzen.ts 2>&1 | tee publish.log
          PUBLISHER_EXIT=$?
          
          echo ""
          echo "Exit code: $PUBLISHER_EXIT"
          echo "publisher_status=$PUBLISHER_EXIT" >> $GITHUB_OUTPUT
          
          # Save log for debugging
          mv publish.log publish-$(date +%s).log || true
        continue-on-error: true
      
      - name: ğŸ“Š Check results
        if: always()
        run: |
          echo "========================================"
          echo "ğŸ“Š WORKFLOW RESULTS"
          echo "========================================"
          
          HISTORY_FILE="!posts/PRODUCTION_READY/published_articles.txt"
          
          if [ -f "$HISTORY_FILE" ]; then
            TOTAL_PUBLISHED=$(wc -l < "$HISTORY_FILE" || echo "0")
            echo "âœ… Publication history exists"
            echo "   Total articles published: $TOTAL_PUBLISHED"
            echo ""
            echo "ğŸ“‹ Last 3 published articles:"
            tail -3 "$HISTORY_FILE" | sed 's/^/   /'
          else
            echo "â„¹ï¸  No articles published yet"
          fi
          
          echo ""
          if [ ${{ steps.publisher.outputs.publisher_status }} -eq 0 ]; then
            echo "âœ… Publisher completed successfully!"
          else
            echo "âš ï¸  Publisher completed with warnings or errors"
          fi
      
      - name: ğŸ’¾ Commit and push updates
        if: always()
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "GitHub Actions Bot"
          
          echo "ğŸ“¤ Preparing to commit history and logs..."
          
          # Add history file
          git add "!posts/PRODUCTION_READY/published_articles.txt" 2>/dev/null || true
          
          # Add logs if they exist
          git add "publish-*.log" 2>/dev/null || true
          
          # Check if there's anything to commit
          if git diff --cached --quiet; then
            echo "â„¹ï¸  No changes to commit"
          else
            echo "ğŸ“ Committing changes..."
            git commit -m "ğŸ¤– Auto-publish: $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)" || echo "âš ï¸  Commit failed"
            
            echo "ğŸ“¥ Pulling latest changes..."
            git pull --rebase origin main || (echo "âš ï¸ Rebase failed, trying merge" && git rebase --abort && git pull origin main)
            
            echo "ğŸ“¤ Pushing to repository..."
            git push origin main
            echo "âœ… Successfully pushed!"
          fi
      
      - name: ğŸ“‹ Summary
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ¤– AUTO-PUBLISHER WORKFLOW SUMMARY   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "ğŸ“‹ What happened:"
          echo "   âœ… Validated DZEN_COOKIES_JSON secret"
          echo "   âœ… Checked feed.xml in /public"
          echo "   âœ… Initialized history file"
          echo "   âœ… Installed dependencies"
          echo "   âœ… Installed Playwright browsers"
          echo "   âœ… Ran auto-publisher (main.js.ci)"
          echo "   âœ… Committed history to git"
          echo "   âœ… Pushed updates using GITHUB_TOKEN"
          echo ""
          echo "ğŸ” Security:"
          echo "   âœ… Cookies from GitHub Secrets (AES-256 encrypted)"
          echo "   âœ… Passed via environment variable"
          echo "   âœ… Masked in logs (GitHub automatic)"
          echo "   âœ… No credentials in repository"
          echo ""
          echo "ğŸ“– Next steps:"
          echo "   â€¢ Check 'Actions' tab for detailed logs"
          echo "   â€¢ View 'published_articles.txt' for history"
          echo "   â€¢ If errors: Check logs and update selectors"
          echo ""
          echo "â° Next run: In 3 hours (or manual trigger)"
          echo ""

  # Notification job (optional)
  notify-on-error:
    runs-on: ubuntu-latest
    needs: publish
    if: failure()
    
    steps:
      - name: ğŸ”” Notify on failure
        run: |
          echo "âš ï¸  Workflow failed!"
          echo "Check: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        continue-on-error: true
