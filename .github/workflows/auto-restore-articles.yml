name: üîß Auto Restore Articles

concurrency:
  group: push-to-main
  cancel-in-progress: false

on:
  schedule:
    - cron: '0 3 * * *' # –ö–∞–∂–¥—É—é –Ω–æ—á—å –≤ 3 AM
  push:
    paths:
      - 'articles/**/*.md'
      - '!articles/**/REPORT.md'
    branches:
      - main
  workflow_dispatch:
    inputs:
      fix_all:
        description: 'Fix ALL articles in articles/ directory'
        required: false
        default: false
        type: boolean
      verbose:
        description: 'Enable verbose logging'
        required: false
        default: false
        type: boolean

jobs:
  restore-articles:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 —á–∞—Å–∞ –º–∞–∫—Å–∏–º—É–º
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: üîç Get changed files
        id: files
        run: |
          echo "üìä Detecting articles..."
          
          # –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º "fix all" - –±–µ—Ä—ë–º –í–°–ï —Å—Ç–∞—Ç—å–∏
          if [ "${{ github.event.inputs.fix_all }}" = "true" ]; then
            echo "üîÑ MODE: Fix ALL articles"
            CHANGED=$(find articles -name "*.md" -not -name "REPORT.md" -type f | sort)
            echo "mode=all" >> $GITHUB_OUTPUT
          else
            echo "üìù MODE: Fix changed articles"
            BEFORE="${{ github.event.before }}"
            AFTER="${{ github.event.after }}"
            
            # –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π –ø—É—à –≤ –≤–µ—Ç–∫—É, before –±—É–¥–µ—Ç –Ω—É–ª—è–º–∏
            if [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
              CHANGED=$(git diff-tree --no-commit-id --name-only -r "$AFTER" -- 'articles/**/*.md' | grep -v "REPORT.md" || true)
            else
              CHANGED=$(git diff --name-only "$BEFORE" "$AFTER" -- 'articles/**/*.md' | grep -v "REPORT.md" || true)
            fi
            echo "mode=changed" >> $GITHUB_OUTPUT
          fi
          
          if [ -z "$CHANGED" ]; then
            echo "‚úÖ No articles found"
            echo "files=" >> $GITHUB_OUTPUT
          else
            echo "üìù Found files:"
            echo "$CHANGED" | while read -r file; do
              echo "   ‚úì $file"
            done
            FILES_STR=$(echo "$CHANGED" | tr '\n' ' ')
            echo "files=$FILES_STR" >> $GITHUB_OUTPUT
          fi

      - name: ü§ñ Restore articles (5-retry strategy)
        if: steps.files.outputs.files != ''
        id: restore
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          VERBOSE: ${{ github.event.inputs.verbose || false }}
        run: |
          MODE="${{ steps.files.outputs.mode }}"
          
          if [ "$MODE" = "all" ]; then
            echo "üöÄ Restoring ALL articles with 5-attempt strategy..."
          else
            echo "üöÄ Restoring changed articles with 5-attempt strategy..."
          fi
          
          if [ "$VERBOSE" = "true" ]; then
            node scripts/restore-articles-safe.js --verbose ${{ steps.files.outputs.files }}
          else
            node scripts/restore-articles-safe.js ${{ steps.files.outputs.files }}
          fi
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          if [ "$EXIT_CODE" -ne 0 ]; then
            echo "‚ùå Script failed with exit code $EXIT_CODE"
          fi
          exit $EXIT_CODE

      - name: üì§ Commit if changed
        if: steps.files.outputs.files != '' && success()
        run: |
          set -e
          echo "üîç ===== PRE-GIT CHECK BEFORE COMMIT ====="
          
          # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
          echo "üìä Current git status:"
          git status --porcelain
          echo ""
          
          # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∫–∏–µ —Ñ–∞–π–ª—ã –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
          echo "üìù Modified files:"
          git ls-files -m || true
          echo ""
          
          # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º diff
          echo "üìä Diff stat:"
          git diff --stat || echo "No diff"
          echo ""
          
          # 4. –°–º–æ—Ç—Ä–∏–º –¥–µ—Ç–∞–ª–∏ –ø–æ –∫–∞–∂–¥–æ–º—É —Ñ–∞–π–ª—É
          FILES='${{ steps.files.outputs.files }}'
          echo "üìÅ Checking specific article files:"
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              SIZE=$(wc -c < "$file" 2>/dev/null || echo "0")
              LINES=$(wc -l < "$file" 2>/dev/null || echo "0")
              echo "   ‚úì $file - $SIZE bytes, $LINES lines"
            else
              echo "   ‚ùå $file - NOT FOUND"
            fi
          done <<< "$FILES"
          echo ""
          
          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Ä–µ–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          if git diff --quiet -- articles/; then
            echo "‚ö†Ô∏è  WARNING: git diff --quiet says NO CHANGES"
            echo "üìä But git status says:"
            git status
            echo ""
            echo "Forcing git add and checking again..."
            git add articles/
            
            if git diff --cached --quiet; then
              echo "‚ö†Ô∏è  Still no changes in staging area. Exit."
              exit 0
            fi
          fi
          
          # 6. –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã
          echo "üìå Adding articles/ directory..."
          git add articles/
          echo "Added successfully"
          
          # 7. –ü—Ä–æ–≤–µ—Ä—è–µ–º staged changes
          echo "üìä Staged diff stat:"
          git diff --cached --stat
          echo ""
          
          # 8. –°–æ–∑–¥–∞—ë–º –∫–æ–º–º–∏—Ç
          MODE="${{ steps.files.outputs.mode }}"
          if [ "$MODE" = "all" ]; then
            COMMIT_MSG="üîß Auto-restore: Fixed ALL articles"
          else
            COMMIT_MSG="üîß Auto-restore: Fixed formatting"
          fi
          
          echo "üíæ Creating commit: $COMMIT_MSG"
          git commit -m "$COMMIT_MSG" -m "Triggered by auto-restore workflow" || {
            echo "‚ùå Commit failed or nothing to commit"
            git status
            exit 0
          }
          
          echo "‚úÖ Commit created"
          echo ""
          
          # 9. –ü—É—à–∏–º –Ω–∞ –≥–∏—Ç—Ö–∞–± —Å retry –ª–æ–≥–∏–∫–æ–π
          echo "üì§ Pushing to origin..."
          
          # Retry –ª–æ–≥–∏–∫–∞: –ø—Ä–æ–±—É–µ–º –¥–æ 5 —Ä–∞–∑ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
          MAX_RETRIES=5
          RETRY_COUNT=0
          PUSH_SUCCESS=false
          
          while [ "$RETRY_COUNT" -lt "$MAX_RETRIES" ]; do
            if [ "$RETRY_COUNT" -gt 0 ]; then
              # –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞: 2^retry —Å–µ–∫—É–Ω–¥
              DELAY=$((2 ** RETRY_COUNT))
              echo "‚è≥ Retry $RETRY_COUNT/$MAX_RETRIES: waiting ${DELAY}s..."
              sleep "$DELAY"
            fi
            
            # –ü—Ä–æ–±—É–µ–º pull —Å rebase –ø–µ—Ä–µ–¥ push
            echo "üì• Pulling latest changes (attempt $((RETRY_COUNT + 1)))..."
            if git pull origin main --rebase 2>&1; then
              echo "‚úÖ Pull successful"
            else
              echo "‚ö†Ô∏è  Rebase failed, trying merge..."
              git rebase --abort 2>/dev/null || true
              if ! git pull origin main 2>&1; then
                echo "‚ö†Ô∏è  Pull failed, continuing with push anyway..."
              fi
            fi
            
            # –ü—Ä–æ–±—É–µ–º push
            echo "üì§ Pushing to origin (attempt $((RETRY_COUNT + 1)))..."
            if git push origin HEAD:${{ github.ref }} --verbose 2>&1; then
              echo "‚úÖ Push successful!"
              PUSH_SUCCESS=true
              break
            else
              echo "‚ùå Push failed (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
              RETRY_COUNT=$((RETRY_COUNT + 1))
            fi
          done
          
          if [ "$PUSH_SUCCESS" = "false" ]; then
            echo "‚ùå Push failed after $MAX_RETRIES attempts!"
            git log --oneline -5
            exit 1
          fi

      - name: üìä Summary
        if: always()
        run: |
          echo ""
          echo "========================================="
          echo "‚úÖ Auto-restore complete"
          echo "========================================="
          MODE="${{ steps.files.outputs.mode }}"
          if [ "$MODE" = "all" ]; then
            echo "üìã Mode: Fix ALL articles"
          else
            echo "üìã Mode: Fix changed articles"
          fi
          FILE_COUNT=$(echo '${{ steps.files.outputs.files }}' | wc -w)
          echo "üìÅ Files processed: $FILE_COUNT"
          
          # Final git log
          echo ""
          echo "Last commits:"
          git log --oneline -3
          echo "========================================="
