name: ğŸ”§ Auto Restore Articles

on:
  push:
    paths:
      - 'articles/women-35-60/**/*.md'
    branches:
      - main
  workflow_dispatch:

jobs:
  restore-articles:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: ğŸ” Get NEW and MODIFIED files only
        id: files
        run: |
          echo "ğŸ“Š Detecting changed files..."
          echo ""
          
          # Ğ•ÑĞ»Ğ¸ ÑÑ‚Ğ¾ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚ (Ğ½ĞµÑ‚ HEAD~1)
          if git rev-parse --verify HEAD~1 &> /dev/null; then
            # Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ğ¼ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ¾Ğ¼
            # -A = Added (Ğ½Ğ¾Ğ²Ñ‹Ğµ)
            # -M = Modified (Ğ¸Ğ·Ğ¼ĞµĞ½Ñ‘Ğ½Ğ½Ñ‹Ğµ)
            CHANGED=$(git diff --name-only --diff-filter=AM HEAD~1 HEAD -- 'articles/women-35-60/**/*.md')
          else
            # Ğ•ÑĞ»Ğ¸ ÑÑ‚Ğ¾ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚ - Ğ±ĞµÑ€Ñ‘Ğ¼ Ğ²ÑĞµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ¸Ğ· ÑÑ‚Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ°
            CHANGED=$(git diff-tree --no-commit-id --name-only -r HEAD -- 'articles/women-35-60/**/*.md')
          fi
          
          if [ -z "$CHANGED" ]; then
            echo "âœ… No NEW or MODIFIED articles found - nothing to restore"
            echo "files=" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“ Found files to restore:"
            echo "$CHANGED" | while read file; do
              echo "   - $file"
            done
            echo ""
            # ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµĞ¼ Ğ² ÑÑ‚Ñ€Ğ¾ĞºÑƒ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ¸ Ğ² ÑĞºÑ€Ğ¸Ğ¿Ñ‚
            FILES_STR=$(echo "$CHANGED" | tr '\n' ' ')
            echo "files=$FILES_STR" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ¤– Restore articles with Gemini
        if: steps.files.outputs.files != ''
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ğŸš€ Starting restoration..."
          echo ""
          node scripts/restore-articles.js ${{ steps.files.outputs.files }}

      - name: ğŸ“¤ Commit restored articles
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞµÑÑ‚ÑŒ Ğ»Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
          if git diff --quiet; then
            echo "âœ… No changes after restoration - articles were already clean"
          else
            echo "ğŸ“ Committing restored articles..."
            git add articles/
            git commit -m "ğŸ”§ Auto-restore: Fixed article formatting and structure" 
            
            echo "ğŸš€ Pushing to main..."
            git push origin main
            echo "âœ… Successfully pushed"
          fi

      - name: âœ… Restore Complete
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âœ… ARTICLE RESTORATION COMPLETE                       â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š Summary:"
          echo "   Files processed: $(echo '${{ steps.files.outputs.files }}' | tr ' ' '\n' | grep -c .)"
          echo "   Mode: NEW & MODIFIED articles only"
          echo "   Status: âœ… Restored and committed"
          echo ""
