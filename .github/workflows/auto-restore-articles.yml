name: ğŸ”§ Auto Restore Articles

on:
  push:
    paths:
      - 'articles/women-35-60/**/*.md'
    branches:
      - main
  workflow_dispatch:
  workflow_run:
    workflows: ['ğŸ¤– Generate Articles']  # â† Ğ¡Ğ›Ğ£Ğ¨ĞĞ•Ğœ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¹ workflow!
    types: [completed]
    branches: [main]

jobs:
  restore-articles:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 50  # Ğ‘Ğ¾Ğ»ÑŒÑˆĞµ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: ğŸ” Get NEW and MODIFIED files (ANY source)
        id: files
        run: |
          echo "ğŸ“Š Detecting changed articles..."
          echo ""
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # ĞœĞ•Ğ¢ĞĞ” 1: Ğ•ÑĞ»Ğ¸ ÑÑ‚Ğ¾ workflow_run (Ğ¾Ñ‚ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ³Ğ¾ ÑĞºÑˆĞ½Ğ°)
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            echo "ğŸ“Œ Mode: WORKFLOW_RUN (Ğ¾Ñ‚ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ³Ğ¾ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ°)"
            
            # Ğ¡Ğ¼Ğ¾Ñ‚Ñ€Ğ¸Ğ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 50 ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ¾Ğ² Ğ¸ Ğ±ĞµÑ€Ñ‘Ğ¼ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ñ‡Ñ‚Ğ¾ Ğ•Ğ¡Ğ¢Ğ¬ Ğ² articles/
            CHANGED=$(find articles/women-35-60 -name "*.md" -type f 2>/dev/null | sort)
            
            if [ -z "$CHANGED" ]; then
              echo "âœ… No articles found"
              echo "files=" >> $GITHUB_OUTPUT
            else
              echo "ğŸ“ Found articles to restore:"
              echo "$CHANGED" | while read file; do
                echo "   - $file"
              done
              FILES_STR=$(echo "$CHANGED" | tr '\n' ' ')
              echo "files=$FILES_STR" >> $GITHUB_OUTPUT
            fi
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # ĞœĞ•Ğ¢ĞĞ” 2: Ğ•ÑĞ»Ğ¸ ÑÑ‚Ğ¾ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹ push (Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ¼ paths)
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          else
            echo "ğŸ“Œ Mode: PUSH (Ğ¿Ñ€ÑĞ¼Ğ¾Ğ¹ push)"
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞµÑÑ‚ÑŒ Ğ»Ğ¸ HEAD~1
            if git rev-parse --verify HEAD~1 &> /dev/null; then
              # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ±Ğ¾Ğ»ÑŒÑˆĞ¸Ğ¹ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€: A, M, T (Added, Modified, Type change)
              CHANGED=$(git diff --name-only --diff-filter=AMT HEAD~1 HEAD -- 'articles/women-35-60/**/*.md')
            else
              # ĞŸĞµÑ€Ğ²Ñ‹Ğ¹ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚
              CHANGED=$(git diff-tree --no-commit-id --name-only -r HEAD -- 'articles/women-35-60/**/*.md')
            fi
            
            if [ -z "$CHANGED" ]; then
              echo "âœ… No new/modified articles found"
              echo "files=" >> $GITHUB_OUTPUT
            else
              echo "ğŸ“ Found changed files:"
              echo "$CHANGED" | while read file; do
                echo "   - $file"
              done
              FILES_STR=$(echo "$CHANGED" | tr '\n' ' ')
              echo "files=$FILES_STR" >> $GITHUB_OUTPUT
            fi
          fi

      - name: ğŸ¤– Restore articles with Gemini
        if: steps.files.outputs.files != ''
        id: restore
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ğŸš€ Starting restoration..."
          echo ""
          FILES="${{ steps.files.outputs.files }}"
          
          if [ -z "$FILES" ]; then
            echo "No files to process"
            echo "exit_code=0" >> $GITHUB_OUTPUT
          else
            node scripts/restore-articles.js $FILES
            echo "exit_code=$?" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“¤ Commit restored articles
        if: steps.files.outputs.files != '' && steps.restore.outputs.exit_code == '0'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞµÑÑ‚ÑŒ Ğ»Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
          if git diff --quiet; then
            echo "âœ… No changes after restoration - articles were already clean"
          else
            echo "ğŸ“ Committing restored articles..."
            git add articles/
            git commit -m "ğŸ”§ Auto-restore: Fixed article formatting and structure" || true
            
            echo "ğŸš€ Pushing to main..."
            git push origin main || echo "âš ï¸  Push skipped (no new commits)"
            echo "âœ… Committed and pushed"
          fi

      - name: âœ… Restore Complete
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          if [ "${{ steps.restore.outputs.exit_code }}" == "0" ]; then
            echo "â•‘  âœ… ARTICLE RESTORATION COMPLETE                       â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "ğŸ“Š Summary:"
            echo "   Source: ${{ github.event_name }}"
            echo "   Files processed: $(echo '${{ steps.files.outputs.files }}' | wc -w)"
            echo "   Status: âœ… Restored and committed"
          else
            echo "â•‘  âš ï¸  ARTICLE RESTORATION SKIPPED                        â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "No articles to process or restoration not needed"
          fi
          echo ""
