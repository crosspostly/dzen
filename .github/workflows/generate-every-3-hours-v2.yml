name: ZenMaster v2.0 - Generate Every 3 Hours

on:
  schedule:
    # Generate every 3 hours: 00:00, 03:00, 06:00, 09:00, 12:00, 15:00, 18:00, 21:00 UTC
    - cron: '0 0,3,6,9,12,15,18,21 * * *'
  workflow_dispatch:
    inputs:
      project:
        description: 'Project ID (e.g., channel-1)'
        required: false
        default: 'channel-1'
      theme:
        description: 'Article theme (optional; if empty, random)'
        required: false
      angle:
        description: 'Narrative angle (confession/scandal/observer)'
        required: false
        default: 'confession'
      emotion:
        description: 'Character emotion (triumph/guilt/shame/liberation/anger)'
        required: false
        default: 'triumph'

jobs:
  generate-article:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: feature/zenmaster-v2.0
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Select theme (auto or manual)
        id: theme_selector
        run: |
          # Manual theme from workflow_dispatch, or random from pool
          MANUAL_THEME="${{ github.event.inputs.theme }}"
          
          if [ -n "$MANUAL_THEME" ]; then
            RANDOM_THEME="$MANUAL_THEME"
          else
            # Random theme pool
            themes=(
              "Ð¯ Ð¼Ð½Ð¾Ð³Ð¾ Ð»ÐµÑ‚ Ð½Ðµ Ð·Ð½Ð°Ð»Ð° Ð¿Ñ€Ð°Ð²Ð´Ñƒ Ð¾Ð± Ð¾Ñ‚Ñ†Ðµ"
              "ÐžÐ½Ð¸ Ð½Ðµ Ð²ÐµÑ€Ð¸Ð»Ð¸ Ð² Ð¼Ð¾ÑŽ Ð¼ÐµÑ‡Ñ‚Ñƒ"
              "ÐžÐ´Ð¸Ð½ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€ Ð²ÑÑ‘ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»"
              "Ð¯ ÑƒÑˆÐ»Ð° Ð¼Ð¾Ð»Ñ‡Ð° Ð¸ Ð½Ðµ Ð¿Ð¾Ð¶Ð°Ð»ÐµÐ»Ð°"
              "20 Ð»ÐµÑ‚ Ñ Ñ‚ÐµÑ€Ð¿ÐµÐ»Ð° ÑÑ‚Ð¾ Ð¼Ð¾Ð»Ñ‡Ð°"
              "Ð¡Ð¾ÑÐµÐ´ÐºÐ° Ð¿Ñ€Ð¸Ð½ÐµÑÐ»Ð° Ð¿Ð¸Ñ€Ð¾Ð³ Ð¸ Ñ€Ð°ÑÑÐºÐ°Ð·Ð°Ð»Ð° Ñ‚Ð°Ð¹Ð½Ñƒ"
              "Ð¯ Ð¾Ñ‚ÐºÑ€Ñ‹Ð»Ð° Ð¿Ð¸ÑÑŒÐ¼Ð¾ Ð¸ Ð¿Ð¾Ð½ÑÐ»Ð°, Ñ‡Ñ‚Ð¾ Ð¶Ð¸Ð²Ñƒ Ð½Ðµ ÑÐ²Ð¾ÐµÐ¹ Ð¶Ð¸Ð·Ð½ÑŒÑŽ"
              "Ð”Ð¾Ñ‡ÑŒ ÑÐ¿Ñ€Ð¾ÑÐ¸Ð»Ð° Ð¼ÐµÐ½Ñ Ð¿Ñ€ÑÐ¼Ð¾ Ð¸ Ñ Ð½Ðµ ÑÐ¼Ð¾Ð³Ð»Ð° ÑÐ¾Ð²Ñ€Ð°Ñ‚ÑŒ"
              "ÐœÑ‹ Ð½Ðµ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð°Ñ€Ð¸Ð²Ð°Ð»Ð¸ Ð¼ÐµÑÑÑ†Ñ‹, Ð° Ð¿Ð¾Ñ‚Ð¾Ð¼ Ð¾Ð½Ð° Ð¿Ñ€Ð¸ÑˆÐ»Ð° Ð²ÐµÑ‡ÐµÑ€Ð¾Ð¼"
              "Ð¯ Ð¿Ñ€Ð¸ÐµÑ…Ð°Ð»Ð° Ð½Ð° Ð¿ÑÑ‚ÑŒ Ð¼Ð¸Ð½ÑƒÑ‚ Ð¸ ÑƒÐµÑ…Ð°Ð»Ð° Ð´Ñ€ÑƒÐ³Ð¸Ð¼ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ¾Ð¼"
            )
            RANDOM_THEME=${themes[$((RANDOM % ${#themes[@]}))]}
          fi
          
          PROJECT="${{ github.event.inputs.project || 'channel-1' }}"
          ANGLE="${{ github.event.inputs.angle || 'confession' }}"
          EMOTION="${{ github.event.inputs.emotion || 'triumph' }}"
          
          echo "theme=$RANDOM_THEME" >> $GITHUB_OUTPUT
          echo "project=$PROJECT" >> $GITHUB_OUTPUT
          echo "angle=$ANGLE" >> $GITHUB_OUTPUT
          echo "emotion=$EMOTION" >> $GITHUB_OUTPUT
          
          echo "ðŸŽ¯ Configuration:"
          echo "  Project: $PROJECT"
          echo "  Theme: $RANDOM_THEME"
          echo "  Angle: $ANGLE"
          echo "  Emotion: $EMOTION"
      
      - name: Generate longform article (35K+)
        run: |
          npx tsx cli.ts generate:v2 \
            --project="${{ steps.theme_selector.outputs.project }}" \
            --theme="${{ steps.theme_selector.outputs.theme }}" \
            --angle="${{ steps.theme_selector.outputs.angle }}" \
            --emotion="${{ steps.theme_selector.outputs.emotion }}"
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      
      - name: Create output directory
        run: mkdir -p generated/articles
      
      - name: Verify article generated
        run: |
          ls -lah generated/articles/ || echo "âš ï¸  No articles generated yet"
          find generated/articles/ -type f -name "*.json" | head -1 || echo "âš ï¸  Article file not found"
      
      - name: Commit and push to feature branch
        run: |
          git config --local user.email "zenmaster-bot@github.com"
          git config --local user.name "ZenMaster Bot"
          
          git add generated/articles/ || true
          
          if git diff --cached --quiet; then
            echo "âœ… No changes to commit"
          else
            git commit -m "ðŸŽ¬ [AUTO] ${{ steps.theme_selector.outputs.theme }} [${{ steps.theme_selector.outputs.angle }}]"
            git push origin feature/zenmaster-v2.0
            echo "âœ… Pushed to feature/zenmaster-v2.0"
          fi
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: generated-article-${{ github.run_id }}
          path: generated/articles/
          retention-days: 90
      
      - name: Generate workflow summary
        if: success()
        run: |
          cat > /tmp/summary.md << 'EOF'
          ## ðŸŽ¬ ZenMaster v2.0 - Generation Success
          
          | Property | Value |
          |----------|-------|
          | **Theme** | ${{ steps.theme_selector.outputs.theme }} |
          | **Project** | ${{ steps.theme_selector.outputs.project }} |
          | **Angle** | ${{ steps.theme_selector.outputs.angle }} |
          | **Emotion** | ${{ steps.theme_selector.outputs.emotion }} |
          | **Generated** | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |
          | **Workflow** | [Run #${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
          | **Branch** | feature/zenmaster-v2.0 |
          
          ### âœ… Output
          - Generated longform article (~35K characters)
          - Saved to `generated/articles/`
          - Committed and pushed
          - Artifact available for 90 days
          EOF
          
          cat /tmp/summary.md >> $GITHUB_STEP_SUMMARY
      
      - name: On failure - notify
        if: failure()
        run: |
          cat > /tmp/error.md << 'EOF'
          ## âŒ Generation Failed
          
          **Theme**: ${{ steps.theme_selector.outputs.theme }}  
          **Project**: ${{ steps.theme_selector.outputs.project }}  
          **Error**: Check [workflow logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ### Common Issues
          - âŒ `GEMINI_API_KEY` not set in Secrets
          - âŒ Project config missing: `projects/${{ steps.theme_selector.outputs.project }}/config.json`
          - âŒ TypeScript compilation error - check `npm install`
          - â±ï¸  Timeout (>30 minutes) - Gemini API slow
          EOF
          
          cat /tmp/error.md >> $GITHUB_STEP_SUMMARY
