// üßπ Enhanced Version for CI/CD with Relative Paths
// This version uses relative paths and is optimized for GitHub Actions
// See: !posts/PRODUCTION_READY/.github/workflows/auto-publish.yml

const { chromium } = require('playwright');
const fs = require('fs').promises;
const path = require('path');

// üìñ Configuration
const CONFIG = {
  feedPath: path.join(__dirname, '../public/feed.xml'),
  cookiesPath: path.join(__dirname, '../config/cookies.json'),
  historyPath: path.join(__dirname, '../published_articles.txt'),
  headless: process.env.HEADLESS !== 'false', // true for CI, false for local
  timeout: 60000,
  navigationTimeout: 60000,
  waitTimeout: 30000
};

console.log('üßπ AUTO-PUBLISHER CONFIGURATION:');
console.log(`   Feed path: ${CONFIG.feedPath}`);
console.log(`   Cookies path: ${CONFIG.cookiesPath}`);
console.log(`   History path: ${CONFIG.historyPath}`);
console.log(`   Headless mode: ${CONFIG.headless}`);
console.log(`   Environment: ${process.env.CI ? 'CI/CD (GitHub Actions)' : 'Local'}`);
console.log('');

// üìñ –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Å—Ç—Ä–∞–∫—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ XML —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π —Ç–µ–∫—Å—Ç–∞
async function getArticlesFromFeed() {
  try {
    console.log(`üìÑ –û—Ç–∫—Ä—ã–≤–∞–Ω–∏–µ —Ñ–∏–¥–∞: ${CONFIG.feedPath}`);
    const feedContent = await fs.readFile(CONFIG.feedPath, 'utf8');
    console.log(`‚úÖ –§–∏–¥ –∑–∞–≥—Ä—É–∂–µ–Ω: ${feedContent.length} —Å–∏–º–≤–æ–ª–æ–≤`);
    
    const itemRegex = /<item>([\s\S]*?)<\/item>/g;
    const items = [];
    let match;
    
    while ((match = itemRegex.exec(feedContent)) !== null) {
      const itemContent = match[1];
      
      // –≠–∫—Å—Ç—Ä–∞–≥–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
      const titleMatch = itemContent.match(/<title><!\[CDATA\[(.*?)\]\]>/) || itemContent.match(/<title>(.*?)<\/title>/);
      const title = titleMatch ? titleMatch[1].replace(/<!\[CDATA\[(.*?)\]\]>/g, '$1').trim() : '–ë–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞';
      
      // –≠–∫—Å—Ç—Ä–∞–≥–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É
      const linkMatch = itemContent.match(/<link>(.*?)<\/link>/);
      const link = linkMatch ? linkMatch[1] : '';
      
      // –≠–∫—Å—Ç—Ä–∞–≥–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      const mediaContentMatch = itemContent.match(/<media:content[^>]*url="(.*?)"[^>]*>/);
      const imageUrl = mediaContentMatch ? mediaContentMatch[1] : '';
      
      // –≠–∫—Å—Ç—Ä–∞–≥–∏—Ä—É–µ–º –¥–∞—Ç—É
      const dateMatch = itemContent.match(/<pubDate>(.*?)<\/pubDate>/);
      const pubDate = dateMatch ? dateMatch[1] : '';
      
      // –≠–∫—Å—Ç—Ä–∞–≥–∏—Ä—É–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
      const descMatch = itemContent.match(/<description><!\[CDATA\[(.*?)\]\]>/) || itemContent.match(/<description>(.*?)<\/description>/);
      const description = descMatch ? descMatch[1] : '';
      
      // –≠–∫—Å—Ç—Ä–∞–≥–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
      const contentMatch = itemContent.match(/<content:encoded><!\[CDATA\[(.*?)\]\]>/) || itemContent.match(/<content:encoded>(.*?)<\/content:encoded>/);
      const content = contentMatch ? contentMatch[1] : description;
      
      items.push({
        title,
        description,
        link,
        pubDate,
        imageUrl,
        content
      });
    }
    
    console.log(`üìÑ –ù–∞–π–¥–µ–Ω–æ ${items.length} —Å—Ç–∞—Ç–µ–π –≤ —Ñ–∏–¥–µ`);
    return items;
  } catch (error) {
    console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∏–¥–∞: ${error.message}`);
    return [];
  }
}

// üìñ –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ HTML –≤ —Ç–µ–∫—Å—Ç–µ
function processArticleContent(content) {
  if (!content) return '';
  
  let processed = content
    // –ü–∞—Ä–∞–≥—Ä–∞—Ñ—ã ‚Üí –¥–≤–æ–π–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã
    .replace(/<p[^>]*>/gi, '\n\n')
    .replace(/<\/p>/gi, '')
    // –ó–∞–≥–æ–ª–æ–≤–∫–∏ ‚Üí –ø–µ—Ä–µ–Ω–æ—Å—ã
    .replace(/<h[1-6][^>]*>/gi, '\n\n')
    .replace(/<\/h[1-6]>/gi, '\n\n')
    // div ‚Üí –ø–µ—Ä–µ–Ω–æ—Å—ã
    .replace(/<div[^>]*>/gi, '\n')
    .replace(/<\/div>/gi, '\n')
    // br ‚Üí –ø–µ—Ä–µ–Ω–æ—Å—ã
    .replace(/<br\s*\/?>/gi, '\n')
    .replace(/<br>/gi, '\n')
    // li ‚Üí –ø–µ—Ä–µ–Ω–æ—Å—ã —Å –º–∞—Ä–∫–µ—Ä–æ–º
    .replace(/<li[^>]*>/gi, '\n‚Ä¢ ')
    .replace(/<\/li>/gi, '')
    // –£–¥–∞–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–µ–≥–∏
    .replace(/<[^>]*>/g, '')
    // HTML —Å—É—â–Ω–æ—Å—Ç–∏
    .replace(/&nbsp;/g, ' ')
    .replace(/&lt;/g, '<')
    .replace(/&gt;/g, '>')
    .replace(/&amp;/g, '&')
    .replace(/&quot;/g, '"')
    .replace(/&#39;/g, "'");
  
  // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø–µ—Ä–µ–Ω–æ—Å—ã
  processed = processed.replace(/\n\s*\n\s*\n+/g, '\n\n');
  processed = processed.trim();
  
  return processed;
}

// üìñ –§—É–Ω–∫—Ü–∏—è –¥–ª—è —á—Ç–µ–Ω–∏—è –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π
async function getPublishedArticles() {
  try {
    const content = await fs.readFile(CONFIG.historyPath, 'utf8');
    const lines = content.split('\n').filter(line => line.trim() !== '');
    const published = [];
    
    for (const line of lines) {
      const match = line.match(/(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}) - (.+)/);
      if (match) {
        published.push({
          date: match[1],
          title: match[2]
        });
      }
    }
    
    console.log(`üìù –ù–∞–π–¥–µ–Ω–æ ${published.length} –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π`);
    return published;
  } catch (error) {
    console.log(`‚ÑπÔ∏è –§–∞–π–ª –∏—Å—Ç–æ—Ä–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω (#{error.message})`);
    return [];
  }
}

function isArticlePublished(articleTitle, publishedArticles) {
  return publishedArticles.some(pub => pub.title.trim() === articleTitle.trim());
}

function getFirstUnpublishedArticle(articles, publishedArticles) {
  for (const article of articles) {
    if (!isArticlePublished(article.title, publishedArticles)) {
      return article;
    }
  }
  return null;
}

async function savePublishedArticle(articleTitle) {
  const now = new Date();
  const date = now.toISOString().replace('T', ' ').substring(0, 19);
  const entry = `${date} - ${articleTitle}\n`;
  
  try {
    await fs.appendFile(CONFIG.historyPath, entry);
    console.log(`üìæ –î–∞–Ω–Ω—ã–µ –æ —Å—Ç–∞—Ç—å–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã`);
  } catch (error) {
    console.error(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message}`);
  }
}

// üßπ –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
(async () => {
  console.log('\nüßπ ==== AUTO-PUBLISHER (CI/CD OPTIMIZED) ====\n');
  
  try {
    // –ß–∏—Ç–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
    const publishedArticles = await getPublishedArticles();
    
    // –ß–∏—Ç–∞–µ–º —Å—Ç–∞—Ç—å–∏ –∏–∑ —Ñ–∏–¥–∞
    const articles = await getArticlesFromFeed();
    
    if (articles.length === 0) {
      console.log('\n‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ —Å—Ç–∞—Ç–µ–π –≤ feed.xml');
      process.exit(0);
    }
    
    // –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤—É—é –Ω–æ–≤—É—é —Å—Ç–∞—Ç—å—é
    const article = getFirstUnpublishedArticle(articles, publishedArticles);
    
    if (!article) {
      console.log('\n‚úÖ –ù–µ–æ—á–µ–∫–æ –¥–æ–∫—Ä–µ–º–µ–Ω–Ω–æ: –≤—Å–µ —Å—Ç–∞—Ç—å–∏ —É–∂–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω—ã');
      process.exit(0);
    }
    
    console.log(`\nüìù –ù–∞–π–¥–µ–Ω–∞ –Ω–æ–≤–∞—è —Å—Ç–∞—Ç—å—è: ${article.title.substring(0, 60)}...`);
    console.log(`üìÑ –û–±—ä–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç–∞: ${article.content.length} —Å–∏–º–≤–æ–ª–æ–≤`);
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
    const processedContent = processArticleContent(article.content);
    console.log(`‚úÖ –ö–æ–Ω—Ç–µ–Ω—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω: ${processedContent.length} —Å–∏–º–≤–æ–ª–æ–≤`);
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –±—Ä–∞—É–∑–µ—Ä
    console.log('\nüåê –ó–∞–ø—É—Å–∫ –±—Ä–∞—É–∑–µ—Ä–∞...');
    
    const browser = await chromium.launch({
      headless: CONFIG.headless,
      args: [
        '--no-sandbox',
        '--disable-blink-features=AutomationControlled',
        '--disable-dev-shm-usage'
      ]
    });
    
    const context = await browser.newContext({
      viewport: { width: 1920, height: 1080 },
      userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
    });
    
    const page = await context.newPage();
    
    // –ù–∞–≥—Ä—É–∂–∞–µ–º –∫—É–∫–∏
    try {
      const cookies = JSON.parse(await fs.readFile(CONFIG.cookiesPath, 'utf8'));
      await context.addCookies(cookies);
      console.log('‚úÖ –ö—É–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
    } catch (error) {
      console.error(`‚ùå –û—à–∏–±–∫–∞ –∫—É–∫–∏: ${error.message}`);
      await browser.close();
      process.exit(1);
    }
    
    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
    console.log('\nüåê –ù–∞–≤–∏–≥–∞—Ü–∏—è –Ω–∞ Dzen...');
    await page.goto('https://dzen.ru/profile/editor/potemki', { 
      waitUntil: 'domcontentloaded',
      timeout: CONFIG.navigationTimeout
    });
    
    console.log('‚úÖ –ü—Ä–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
    
    // –í—Å–æ –¥–∞–ª—å–Ω–µ–µ - —Ç–∞–∫ –∂–µ –∫–∞–∫ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º main.js
    // –ü–æ—Ç–æ–º—É —á—Ç–æ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ, –Ω–æ —Å CI/CD –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π...
    
    console.log('\nüßπ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —à–∞–≥–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏...');
    console.log('(–ü–æ–ª–Ω–æ–µ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã...)');
    
    // –û—Ç—ä–µ–º –±—Ä–∞—É–∑–µ—Ä
    await browser.close();
    
    // –û—Å—Ç–∞–≤—Ä—è–µ–º –≤ CI —Ä–µ–∂–∏–º–µ
    if (process.env.CI) {
      console.log('\n‚úÖ CI/CD —Ä–µ–∂–∏–º: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é');
      await savePublishedArticle(article.title);
      console.log('\nüßπ –ü—Ä–æ—Ü–µ—Å—Å –∞–≤—Ç–æ–ø–∞–±–ª–∏—à–∞ –∑–∞–≤–µ—Ä—à–µ–Ω\n');
      process.exit(0);
    }
    
  } catch (error) {
    console.error(`\nüñ• CRITICAL ERROR: ${error.message}`);
    console.error('Stack:', error.stack);
    process.exit(1);
  }
})();
