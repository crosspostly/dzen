import { GoogleGenAI } from "@google/genai";
import { Episode, EpisodeOutline } from "../types/ContentArchitecture";
import { ContentSanitizer } from "./contentSanitizer";
import { ImageGeneratorService } from "./imageGeneratorService";
import { ImageProcessorService } from "./imageProcessorService";

export class EpisodeGeneratorService {
  private geminiClient: GoogleGenAI;
  private readonly INITIAL_RETRY_DELAY = 2000;
  private readonly MAX_RETRIES = 3;
  private imageGenerator: ImageGeneratorService;
  private imageProcessor: ImageProcessorService;

  constructor(apiKey?: string) {
    const key = apiKey || process.env.GEMINI_API_KEY || process.env.API_KEY || '';
    this.geminiClient = new GoogleGenAI({ apiKey: key });
    this.imageGenerator = new ImageGeneratorService(key);
    this.imageProcessor = new ImageProcessorService();
  }

  async generateSingleEpisode(
    episodeOutline: EpisodeOutline
  ): Promise<Episode> {
    console.log(`\n   üé¨ Episode #${episodeOutline.id} - Starting generation...`);

    // Attempt 1: Standard prompt
    console.log(`   üìù Attempt 1/5: Standard prompt (Sapogi style)`);
    let content = await this.generateWithPrompt(
      episodeOutline,
      this.buildStandardPrompt(episodeOutline)
    );

    if (this.isValidLength(content)) {
      return this.buildEpisode(episodeOutline, content);
    }

    console.log(`   ‚ö†Ô∏è  Too short (${content.length} chars), trying expanded...`);

    // Attempt 2: Expanded prompt with examples
    console.log(`   üìù Attempt 2/5: Expanded prompt (More details)`);
    content = await this.generateWithPrompt(
      episodeOutline,
      this.buildExpandedPrompt(episodeOutline)
    );

    if (this.isValidLength(content)) {
      return this.buildEpisode(episodeOutline, content);
    }

    console.log(`   ‚ö†Ô∏è  Still too short (${content.length} chars), trying breakdown...`);

    // Attempt 3: Breakdown by parts
    console.log(`   üìù Attempt 3/5: Breakdown prompt (4 parts: open ‚Üí escalation ‚Üí climax ‚Üí resolution)`);
    content = await this.generateWithBreakdown(episodeOutline);

    if (this.isValidLength(content)) {
      return this.buildEpisode(episodeOutline, content);
    }

    console.log(`   ‚ö†Ô∏è  Breakdown failed (${content.length} chars), using fallback...`);

    // Attempt 4: Fallback - two parts combined
    console.log(`   üìù Attempt 4/5: Fallback generation (2 large parts: Part 1 + Part 2)`);
    content = await this.generateFallback(episodeOutline);

    if (this.isValidLength(content)) {
      return this.buildEpisode(episodeOutline, content);
    }

    console.log(`   ‚ö†Ô∏è  Fallback too short (${content.length} chars), EMERGENCY MODE...`);

    // Attempt 5: Emergency - raw maximum length generation
    console.log(`   üìù Attempt 5/5: EMERGENCY (Raw generation, no limits)`);
    content = await this.generateEmergency(episodeOutline);

    if (!this.isValidLength(content)) {
      throw new Error(
        `Episode #${episodeOutline.id} FAILED ALL 5 ATTEMPTS (max ${content.length} chars)`
      );
    }

    return this.buildEpisode(episodeOutline, content);
  }

  /**
   * üñºÔ∏è –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–ê–Ø –ì–ï–ù–ï–†–ê–¶–ò–Ø: —Ç–µ–∫—Å—Ç + –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
   */
  async generateSingleEpisodeWithImage(
    episodeOutline: EpisodeOutline
  ): Promise<Episode & { imageBuffer?: Buffer }> {
    console.log(`\nüé¨ Episode #${episodeOutline.id} - Starting PARALLEL generation...`);

    // üß† –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —ç–ø–∏–∑–æ–¥–∞ (–∫–∞–∫ –æ–±—ã—á–Ω–æ)
    const contentPromise = this.generateSingleEpisode(episodeOutline);
    
    // üñºÔ∏è –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    const imageDataUrlPromise = this.imageGenerator.generateVisual(
      `${episodeOutline.internalConflict} - ${episodeOutline.externalConflict}`
    );

    // ‚ö° –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–û–ï –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
    const [episode, imageDataUrl] = await Promise.all([
      contentPromise,
      imageDataUrlPromise
    ]);

    // üé® –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    let imageBuffer: Buffer | undefined;
    if (imageDataUrl) {
      console.log(`   ‚úÖ Image generated, processing...`);
      imageBuffer = await this.imageProcessor.processImage(imageDataUrl);
      console.log(`   ‚úÖ Image processed: ${Math.round(imageBuffer.length / 1024)} KB`);
    } else {
      console.log(`   ‚ö†Ô∏è  Image generation failed, episode without image`);
    }

    return {
      ...episode,
      imageBuffer
    };
  }

  /**
   * üé¨ LEVEL 1: Standard prompt - Sapogi style (3000-4000 chars)
   */
  private buildStandardPrompt(outline: EpisodeOutline): string {
    return `üé¨ –ù–ê–ü–ò–®–ò –ü–û–õ–ù–û–ö–†–û–í–ù–£–Æ –°–¶–ï–ù–£ (3000-4000 —Å–∏–º–≤–æ–ª–æ–≤):

–ì–ï–†–û–ò–ù–Ø: ${outline.internalConflict}
–ö–û–ù–§–õ–ò–ö–¢: ${outline.externalConflict}
–ß–¢–û –û–ù–ê –ß–£–í–°–¢–í–£–ï–¢: ${outline.internalConflict}
–ü–ï–†–ï–õ–û–ú–ù–´–ô –ú–û–ú–ï–ù–¢: ${outline.keyTurning}
–ù–ê –ß–ï–ú –ó–ê–í–ò–°–ê–ï–¢ –ß–ò–¢–ê–¢–ï–õ–¨: ${outline.openLoop}

–ü–†–ê–í–ò–õ–ê –ü–ò–°–¨–ú–ê "–°–ê–ü–û–ì–ò" –°–¢–ò–õ–¨:

1Ô∏è‚É£ –î–ï–¢–ê–õ–ò –†–ï–ê–õ–¨–ù–û–°–¢–ò (–Ω–µ –ø—Ä–æ—Å—Ç–æ —Å–ª–æ–≤–∞):
   - –ó–∞–ø–∞—Ö–∏: "–ó–∞–ø–∞—Ö –Ω–æ–≤–æ–π –∫–æ–∂–∏ —É–¥–∞—Ä–∏–ª –≤ –Ω–æ—Å, –≤—ã–∑–≤–∞–≤ –ª–µ–≥–∫–æ–µ –≥–æ–ª–æ–≤–æ–∫—Ä—É–∂–µ–Ω–∏–µ"
   - –ó–≤—É–∫–∏: "–ö–∞–∂–¥—ã–π —à–∞–≥ –æ—Ç–¥–∞–≤–∞–ª—Å—è —Ö–ª—é–ø–∞—é—â–∏–º –∑–≤—É–∫–æ–º"
   - –û—â—É—â–µ–Ω–∏—è: "–°–µ—Ä–¥—Ü–µ —Å–¥–µ–ª–∞–ª–æ –Ω–µ–ø—Ä–∏—è—Ç–Ω—ã–π –∫—É–ª—å–±–∏—Ç", "–ì–æ—Ä–ª–æ —Å–∂–∞–ª–æ—Å—å"
   - –í–µ—â–∏ –∏–º–µ—é—Ç –ò–°–¢–û–†–ò–Æ: "–°–∞–ø–æ–≥–∏, –∫—É–ø–ª–µ–Ω–Ω—ã–µ —Ç—Ä–∏ –≥–æ–¥–∞ –Ω–∞–∑–∞–¥ –Ω–∞ —Ç–æ–π –∂–µ —Ä–∞—Å–ø—Ä–æ–¥–∞–∂–µ"
   - –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, –≤–ª–∞–≥–∞: "–õ–µ–¥—è–Ω–∞—è –≤–æ–¥–∞ –≤ –±–æ—Ç–∏–Ω–∫–∞—Ö, –±–µ—Å–ø–æ—â–∞–¥–Ω–∞—è"

2Ô∏è‚É£ –í–ù–£–¢–†–ï–ù–ù–ò–ô –ì–û–õ–û–° –ì–ï–†–û–ò–ù–ò (–≥–ª–∞–≤–Ω–æ–µ!):
   - –ù–ï "–æ–Ω–∞ –¥—É–º–∞–ª–∞", –∞ "—è –ø–æ–Ω–∏–º–∞–ª–∞", "—è —á—É–≤—Å—Ç–≤–æ–≤–∞–ª–∞", "—è –≤–∏–¥–µ–ª–∞"
   - –ï—ë –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è –í–ü–õ–ï–¢–ï–ù–´ –≤ –¥–µ–π—Å—Ç–≤–∏–µ (–Ω–µ –æ—Ç–¥–µ–ª—å–Ω–æ)
   - –ï—ë –±–æ–ª—å –ø–æ–∫–∞–∑–∞–Ω–∞ –¥–µ—Ç–∞–ª—è–º–∏, –Ω–µ –æ–±—ä—è—Å–Ω–µ–Ω–∞ —Å–ª–æ–≤–∞–º–∏
   - –ü–µ—Ä–≤–æ–µ –ª–∏—Ü–æ, –∏—Å–ø–æ–≤–µ–¥–∞–ª—å–Ω—ã–π —Ç–æ–Ω: "–î–≤–∞ –º–µ—Å—è—Ü–∞ —è –µ–ª–∞ –ø—É—Å—Ç—É—é –≥—Ä–µ—á–∫—É..."
   - –ï—ë –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –∏ —Å–∏–º–≤–æ–ª—ã: "–≠—Ç–æ –±—ã–ª–∞ –∫–∞–∫–∞—è-—Ç–æ –¥—å—è–≤–æ–ª—å—Å–∫–∞—è —Ä–∞—Å—á–µ—Ç —Å—É–¥—å–±—ã"

3Ô∏è‚É£ –î–ò–ê–õ–û–ì–ò - –†–ï–ó–ö–ò–ï, –ñ–ò–í–´–ï, –ß–ê–°–¢–û:
   - –ö–æ—Ä–æ—Ç–∫–∏–µ —Ä–µ–ø–ª–∏–∫–∏ (1-2 —Å–ª–æ–≤–∞ –æ–±—ã—á–Ω–æ)
   - –ü–µ—Ä–µ–±–∏–≤–∞—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞
   - –ì–æ–≤–æ—Ä—è—Ç –Ω–µ —Å–ª–æ–≤–∞–º–∏, –∞ –¢–ï–õ–û–ú: "‚Äî –≠—Ç–æ —á—Ç–æ? ‚Äî —Ç–∫–Ω—É–ª –ø–∞–ª—å—Ü–µ–º –≤ –ø–∞–∫–µ—Ç"
   - –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –∏ –∏–º–µ–Ω–∞: "‚Äî –ó–∞ —Å–∫–æ–ª—å–∫–æ? ‚Äî –ó–∞ –ø—è—Ç–Ω–∞–¥—Ü–∞—Ç—å"
   - –≠–º–æ—Ü–∏—è –≤ —Ä–µ–ø–ª–∏–∫–µ: "‚Äî –¢—ã –∑–∞—á–µ–º —Å–µ–±–µ —Å–∞–ø–æ–≥–∏ –∫—É–ø–∏–ª–∞?! ‚Äî —Ä—è–≤–∫–Ω—É–ª –æ–Ω"

4Ô∏è‚É£ –î–ï–ô–°–¢–í–ò–ï –ö–ê–ö –í –ö–ò–ù–û (–Ω–µ –æ–ø–∏—Å–∞–Ω–∏–µ, –∞ —Å—Ü–µ–Ω–∞):
   - –ù–µ "–æ–Ω–∏ —Å—Å–æ—Ä–∏–ª–∏—Å—å", –∞ —Ç–æ—á–Ω–∞—è —Å—Ü–µ–Ω–∞:
     "–û–Ω —Å—Ö–≤–∞—Ç–∏–ª —Ä—É—á–∫–∏ –ø–∞–∫–µ—Ç–∞ –æ–±–µ–∏–º–∏ —Ä—É–∫–∞–º–∏. –Ø –∏–Ω—Å—Ç–∏–Ω–∫—Ç–∏–≤–Ω–æ –¥–µ—Ä–Ω—É–ª–∞ –∏—Ö –Ω–∞ —Å–µ–±—è. 
      –ö–∞—Ä—Ç–æ–Ω–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞ –∑–∞—Ç—Ä–µ—â–∞–ª–∞ –æ—Ç –Ω–∞—Ç—è–∂–µ–Ω–∏—è."
   - –ß–∏—Ç–∞—Ç–µ–ª—å –í–ò–î–ò–¢ –¥–≤–∏–∂–µ–Ω–∏–µ, –°–õ–´–®–ò–¢ –∑–≤—É–∫–∏, –ß–£–í–°–¢–í–£–ï–¢ –±–æ–ª—å
   - –§–∏–∑–∏–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞: —Ç—è–Ω—É—Ç ‚Üí —Ä–≤–µ—Ç—Å—è ‚Üí –∫—Ä–∞—Å–Ω—ã–µ —Å–ª–µ–¥—ã –Ω–∞ –ª–∞–¥–æ–Ω—è—Ö

5Ô∏è‚É£ –°–ò–ú–í–û–õ–´ –í –î–ï–¢–ê–õ–Ø–•:
   - –î—ã—Ä—è–≤—ã–µ –±–æ—Ç–∏–Ω–∫–∏ = –µ—ë –∂–∏–∑–Ω—å (–ø—Ä–æ—Ç–µ–∫–∞–µ—Ç, —Ö–æ–ª–æ–¥–Ω–æ, —É–Ω–∏–∑–∏—Ç–µ–ª—å–Ω–æ)
   - –ù–æ–≤—ã–µ —Å–∞–ø–æ–≥–∏ = –ø—Ä–∞–≤–æ –Ω–∞ —Å–µ–±—è, —Ç—Ä—É–¥–æ–≤–æ–π –¥–æ—Ö–æ–¥, –¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–æ
   - –î–µ–Ω—å–≥–∏ = –µ—ë —Ç—Ä—É–¥, –µ—ë –≤—ã–±–æ—Ä, –µ—ë –≤–ª–∞—Å—Ç—å –Ω–∞–¥ –∂–∏–∑–Ω—å—é

6Ô∏è‚É£ –°–¢–†–£–ö–¢–£–†–ê –°–¶–ï–ù–´ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û):
   üìç –ó–ê–í–Ø–ó–ö–ê (500-800 —Å–∏–º–≤–æ–ª–æ–≤): –æ–±—Å—Ç–∞–Ω–æ–≤–∫–∞ + –µ—ë —Å–æ—Å—Ç–æ—è–Ω–∏–µ + –∂–µ–ª–∞–Ω–∏–µ
   üìç –†–ê–ó–í–ò–¢–ò–ï (1000-1500 —Å–∏–º–≤–æ–ª–æ–≤): –¥–∏–∞–ª–æ–≥–∏ + –∫–æ–Ω—Ñ–ª–∏–∫—Ç + –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è
   üìç –ö–£–õ–¨–ú–ò–ù–ê–¶–ò–Ø (800-1200 —Å–∏–º–≤–æ–ª–æ–≤): —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π/—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –≤–∑—Ä—ã–≤
   üìç –ü–ï–†–ï–õ–û–ú–ù–´–ô –ú–û–ú–ï–ù–¢ (400-600 —Å–∏–º–≤–æ–ª–æ–≤): –µ—ë —Ä–µ—à–µ–Ω–∏–µ –º–µ–Ω—è–µ—Ç –í–°–Å
   üìç –ö–õ–ò–§–§–•–≠–ù–ì–ï–† (200-300 —Å–∏–º–≤–æ–ª–æ–≤): –≤–æ–ø—Ä–æ—Å, —á—Ç–æ –±—É–¥–µ—Ç –¥–∞–ª—å—à–µ?

7Ô∏è‚É£ –Ø–ó–´–ö:
   - –†—É—Å—Å–∫–∏–π (–Ω–µ "–æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–π —Ä–∞—Å—Å–∫–∞–∑", –∞ "–¥–ª–∏–Ω–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è")
   - –ö–∞–∫ –∏—Å–ø–æ–≤–µ–¥—å –ø–æ–¥—Ä—É–≥–µ (–æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω–æ—Å—Ç—å, —á–µ—Å—Ç–Ω–æ—Å—Ç—å)
   - –ï—Å—Ç—å —é–º–æ—Ä (–≥–æ—Ä—å–∫–∏–π, –∏—Ä–æ–Ω–∏—á–Ω—ã–π): "–ú–æ–∂–µ—Ç –±—ã—Ç—å, –Ω–∞–ø–∏—Å–∞—Ç—å –±–ª–∞–≥–æ–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø–∏—Å—å–º–æ?"
   - –ö–æ–Ω—Ç—Ä–∞—Å—Ç—ã: "–Ø –∂–∏–ª–∞ –≤ —Ç–µ–ø–ª–µ, –Ω–æ –º–Ω–µ –±—ã–ª–æ —Ö–æ–ª–æ–¥–Ω–æ"
   - –î–ª–∏–Ω–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (–æ–ø–∏—Å–∞–Ω–∏–µ) + –ö–û–†–û–¢–ö–ò–ï –¥–∏–∞–ª–æ–≥–∏ (–¥–µ–π—Å—Ç–≤–∏–µ)

–ü–†–ò–ú–ï–† (–ø–µ—Ä–≤—ã–µ 400 —Å–∏–º–≤–æ–ª–æ–≤):
"–í–µ—Ç–µ—Ä –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –Ω–æ—è–±—Ä—è –±—ã–ª –æ—Å–æ–±–µ–Ω–Ω–æ –∑–ª—ã–º. –û–Ω –ø—Ä–æ–±–∏—Ä–∞–ª—Å—è –ø–æ–¥ –º–æ–µ —Å—Ç–∞—Ä–æ–µ –ø–∞–ª—å—Ç–æ, 
–∫—É–ø–ª–µ–Ω–Ω–æ–µ –ø—è—Ç—å –ª–µ—Ç –Ω–∞–∑–∞–¥ –Ω–∞ —Ä–∞—Å–ø—Ä–æ–¥–∞–∂–µ –≤ ¬´–ê—à–∞–Ω–µ¬ª, –∫–æ–ª–æ–ª –ª–∏—Ü–æ –º–µ–ª–∫–∏–º–∏ –ª–µ–¥—è–Ω—ã–º–∏ –∏–≥–æ–ª–∫–∞–º–∏ 
–∏, –∫–∞–∑–∞–ª–æ—Å—å, —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ —Ü–µ–ª–∏–ª—Å—è –≤ –Ω–æ–≥–∏. –ú–æ–∏ –±–æ—Ç–∏–Ω–∫–∏, –∫—É–ø–ª–µ–Ω–Ω—ã–µ —Ç—Ä–∏ –≥–æ–¥–∞ –Ω–∞–∑–∞–¥ –Ω–∞ —Ç–æ–π –∂–µ 
—Ä–∞—Å–ø—Ä–æ–¥–∞–∂–µ, –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ —Å–¥–∞–ª–∏—Å—å."

‚úÖ –ò–¢–û–ì–û: 3000+ —Å–∏–º–≤–æ–ª–æ–≤ –ñ–ò–í–û–ì–û, –±–æ–ª–µ–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ä–∞—Å—Å–∫–∞–∑–∞!
–ù–µ –±–µ—Ä–∏—Å—å –∫—Ä–∞—Ç–∫–æ! –†–∞—Å—Å–∫–∞–∂–∏ –ü–û–õ–ù–û–°–¢–¨–Æ!

Output ONLY episode text (no JSON, no metadata):`;
  }

  /**
   * ‚ö†Ô∏è LEVEL 2: Expanded prompt - More details (3500+ chars)
   */
  private buildExpandedPrompt(outline: EpisodeOutline): string {
    return `‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! –ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–∞—Å—Å–∫–∞–∑ –±—ã–ª –°–õ–ò–®–ö–û–ú –ö–û–†–û–¢–ö–ò–ú –ò –°–ö–û–ú–ö–ê–ù–ù–´–ú!

–ù–ê–ü–ò–®–ò –†–ê–ó–í–Å–†–ù–£–¢–£–Æ, –ü–û–î–†–û–ë–ù–£–Æ, –ü–û–õ–ù–û–ö–†–û–í–ù–£–Æ –°–¶–ï–ù–£ (–ú–ò–ù–ò–ú–£–ú 3500 —Å–∏–º–≤–æ–ª–æ–≤):

–ì–ï–†–û–ò–ù–Ø –ò –ï–Å –°–ò–¢–£–ê–¶–ò–Ø: ${outline.internalConflict}
–í–ù–ï–®–ù–ò–ô –ö–û–ù–§–õ–ò–ö–¢: ${outline.externalConflict}
–ï–Å –í–ù–£–¢–†–ï–ù–ù–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï: ${outline.internalConflict}
–ü–ï–†–ï–õ–û–ú–ù–´–ô –ú–û–ú–ï–ù–¢: ${outline.keyTurning}
–ß–ò–¢–ê–¢–ï–õ–¨ –ñ–î–ï–¢ –û–¢–í–ï–¢–ê: ${outline.openLoop}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üéØ –ì–õ–ê–í–ù–û–ï –ü–†–ê–í–ò–õ–û: –≠—Ç–∞ –≤–µ—Ä—Å–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ù–ï–°–ü–ï–®–ù–û–ô –∏ –î–ï–¢–ê–õ–¨–ù–û–ô!
   - –ù–µ —Å–ø–µ—à–∏, –Ω–µ –∫—Ä–∞—Ç–∫–æ! –ú–µ–¥–ª–µ–Ω–Ω–æ —Ä–∞—Å–∫—Ä—ã–≤–∞–π –∏—Å—Ç–æ—Ä–∏—é.
   - –ö–∞–∂–¥–æ–µ —á—É–≤—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ü–û–ö–ê–ó–ê–ù–û, –Ω–µ —Ä–∞—Å—Å–∫–∞–∑–∞–Ω–æ
   - –ö–∞–∂–¥—ã–π –¥–∏–∞–ª–æ–≥ –¥–æ–ª–∂–µ–Ω —É–¥–∞—Ä—è—Ç—å –ø–æ —Å–µ—Ä–¥—Ü—É
   - –ö–∞–∂–¥–∞—è –¥–µ—Ç–∞–ª—å –¥–æ–ª–∂–Ω–∞ –∏–º–µ—Ç—å –°–ú–´–°–õ

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìù –ü–û–ö–ê–ñ–ò –≠–ú–û–¶–ò–ò –ß–ï–†–ï–ó –¢–ï–õ–û (–æ—á–µ–Ω—å –≤–∞–∂–Ω–æ!):
   - –°–µ—Ä–¥—Ü–µ: "–°–µ—Ä–¥—Ü–µ —Å–¥–µ–ª–∞–ª–æ –Ω–µ–ø—Ä–∏—è—Ç–Ω—ã–π –∫—É–ª—å–±–∏—Ç", "–°–µ—Ä–¥—Ü–µ –∫–æ–ª–æ—Ç–∏–ª–æ—Å—å"
   - –†—É–∫–∏: "–†—É–∫–∏ –¥—Ä–æ–∂–∞–ª–∏", "–ü–∞–ª—å—Ü—ã —Å–∂–∏–º–∞–ª–∏—Å—å –≤ –∫—É–ª–∞–∫", "–†—É–∫–∏ –Ω–µ–≤–æ–ª—å–Ω–æ –¥–µ—Ä–Ω—É–ª–∏—Å—å"
   - –ì–ª–∞–∑–∞: "–ù–∞ –≥–ª–∞–∑–∞ –Ω–∞–≤–æ—Ä–∞—á–∏–≤–∞–ª–∏—Å—å —Å–ª–µ–∑—ã", "–ú–Ω–µ –∑–∞–ª–æ–∂–∏–ª–æ —É—à–∏ –æ—Ç –≥—Ä–æ–º–∫–æ—Å—Ç–∏"
   - –ì–æ—Ä–ª–æ: "–ì–æ—Ä–ª–æ —Å–∂–∞–ª–æ—Å—å", "–ì–æ–ª–æ—Å –¥—Ä–æ–≥–Ω—É–ª", "–°–ª–æ–≤–∞ –∑–∞—Å—Ç—Ä—è–ª–∏ –≤ –≥–æ—Ä–ª–µ"
   - –ñ–∏–≤–æ—Ç: "–í–æ–ª–Ω–∞ —Ç–æ—à–Ω–æ—Ç—ã –ø–æ–¥–Ω—è–ª–∞—Å—å –∏–∑ –∂–∏–≤–æ—Ç–∞", "–ö–æ–º –ø–æ–¥–∫–∞—Ç–∏–ª –∫ –≥–æ—Ä–ª—É"
   - –°–ø–∏–Ω–∞: "–ü–æ —Å–ø–∏–Ω–µ –ø—Ä–æ–±–µ–∂–∞–ª —Ö–æ–ª–æ–¥–æ–∫", "–í–∑–¥—Ä–æ–≥–Ω—É–ª–∞, —Ä–∞—Å–ø—Ä—è–º–∏–ª–∞ –ø–ª–µ—á–∏"
   - –í–Ω—É—Ç—Ä–∏: "–í–Ω—É—Ç—Ä–∏ –∫–∏–ø–∏—Ç –∏ –≤–æ—Ä–æ—á–∞–µ—Ç—Å—è —á—Ç–æ-—Ç–æ –æ–≥—Ä–æ–º–Ω–æ–µ"

üèôÔ∏è –î–ï–¢–ê–õ–ò –û–ë–°–¢–ê–ù–û–í–ö–ò (–Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞–π!):
   - –ó–ê–ü–ê–•–ò (–≥–ª–∞–≤–Ω–æ–µ!): "–ó–∞–ø–∞—Ö –Ω–æ–≤–æ–π –∫–æ–∂–∏ —É–¥–∞—Ä–∏–ª –≤ –Ω–æ—Å, –≤—ã–∑–≤–∞–≤ –ª–µ–≥–∫–æ–µ –≥–æ–ª–æ–≤–æ–∫—Ä—É–∂–µ–Ω–∏–µ"
   - –ó–í–£–ö–ò: "–ö–∞–∂–¥—ã–π —à–∞–≥ –æ—Ç–¥–∞–≤–∞–ª—Å—è —Ö–ª—é–ø–∞—é—â–∏–º –∑–≤—É–∫–æ–º –∏ –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–º —Ö–æ–ª–æ–¥–æ–º"
   - –í–ò–î: "–ù–∞ –ª–∞–¥–æ–Ω—è—Ö –æ—Å—Ç–∞–ª–∏—Å—å –∫—Ä–∞—Å–Ω—ã–µ –±–æ–ª–µ–∑–Ω–µ–≤—ã–µ —Å–ª–µ–¥—ã, —Ä–≤—É—â–∏–µ –∫–æ–∂—É"
   - –û–©–£–©–ï–ù–ò–Ø: "–õ–µ–¥—è–Ω–∞—è –≤–æ–¥–∞ –≤ –±–æ—Ç–∏–Ω–∫–∞—Ö, –±–µ—Å–ø–æ—â–∞–¥–Ω–∞—è"
   - –¢–ï–ú–ü–ï–†–ê–¢–£–†–ê: "–•–æ–ª–æ–¥–Ω—ã–π –≤–µ—Ç–µ—Ä –ø—Ä–æ–±–∏—Ä–∞–ª—Å—è –ø–æ–¥ –º–æ–µ —Å—Ç–∞—Ä–æ–µ –ø–∞–ª—å—Ç–æ"
   - –í–†–ï–ú–Ø: "–í–µ—Ç–µ—Ä –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –Ω–æ—è–±—Ä—è –±—ã–ª –æ—Å–æ–±–µ–Ω–Ω–æ –∑–ª—ã–º"

üí≠ –í–ù–£–¢–†–ï–ù–ù–ò–ô –ì–û–õ–û–° –ì–ï–†–û–ò–ù–ò (–ì–õ–ê–í–ù–û–ï!):
   - –ï—ë —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è: "–î–≤–∞ –º–µ—Å—è—Ü–∞ —è –µ–ª–∞ –ø—É—Å—Ç—É—é –≥—Ä–µ—á–∫—É —Å —Å–æ–ª—å—é –≤ –æ—Ñ–∏—Å–Ω–æ–π —Å—Ç–æ–ª–æ–≤–æ–π..."
   - –ï—ë –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è: "–ó–∞ –ø—è—Ç—å –ª–µ—Ç –±—Ä–∞–∫–∞ —è –ø–æ–Ω—è–ª–∞: –≤ –µ–≥–æ –º–∏—Ä–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç —Ç–æ–ª—å–∫–æ –µ–≥–æ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏"
   - –ï—ë –æ—Å–æ–∑–Ω–∞–Ω–∏—è (–º–µ–¥–ª–µ–Ω–Ω–æ–µ –æ—Ç–∫—Ä–æ–≤–µ–Ω–∏–µ): "–ú–æ–∂–µ—Ç –±—ã—Ç—å, –Ω–∞–ø–∏—Å–∞—Ç—å –±–ª–∞–≥–æ–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø–∏—Å—å–º–æ?"
   - –ï—ë –±–æ–ª—å: "–í–Ω—É—Ç—Ä–∏ –º–µ–Ω—è —á—Ç–æ-—Ç–æ —â–µ–ª–∫–Ω—É–ª–æ. –ü—Ä–æ—Å—Ç–æ ‚Äî —â–µ–ª–∫, –∏ —Ç–µ–º–Ω–æ—Ç–∞."
   - –ï—ë –∫–æ–Ω—Ç—Ä–∞—Å—Ç: "–Ø –∂–∏–ª–∞ —Å —á–µ–ª–æ–≤–µ–∫–æ–º, –Ω–æ –≤—Å–µ–≥–¥–∞ –±—ã–ª–∞ –≤ –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–µ"

üí¨ –î–ò–ê–õ–û–ì - –¢–û–õ–¨–ö–û –ö–†–ê–¢–ö–ò–ï –†–ï–ü–õ–ò–ö–ò, –ë–û–õ–¨–ù–û:
   ‚Äî –≠—Ç–æ —á—Ç–æ?
   ‚Äî –°–∞–ø–æ–≥–∏, ‚Äî –≤—ã–¥–æ—Ö–Ω—É–ª–∞ —è, –∫—Ä–µ–ø—á–µ –ø—Ä–∏–∂–∏–º–∞—è –ø–æ–∫—É–ø–∫—É –∫ —Å–µ–±–µ.
   ‚Äî –ó–∞ —Å–∫–æ–ª—å–∫–æ?
   ‚Äî –ó–∞ –ø—è—Ç–Ω–∞–¥—Ü–∞—Ç—å, ‚Äî –≥–æ–ª–æ—Å –º–æ–π –ø—Ä–µ–¥–∞—Ç–µ–ª—å—Å–∫–∏ –¥—Ä–æ–≥–Ω—É–ª.
   ‚Äî –¢—ã –∑–∞—á–µ–º —Å–µ–±–µ —Å–∞–ø–æ–≥–∏ –∫—É–ø–∏–ª–∞? –£ –º–æ–µ–π —Å–µ—Å—Ç—Ä—ã –∫—Ä–µ–¥–∏—Ç –≥–æ—Ä–∏—Ç! ‚Äî —Ä—è–≤–∫–Ω—É–ª –æ–Ω.

üé¨ –î–í–ò–ñ–ï–ù–ò–ï –î–ï–ô–°–¢–í–ò–Ø (–∫–∞–∫ –≤ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º –∫–∏–Ω–æ):
   1Ô∏è‚É£ –û–ù–ê –í–ò–î–ò–¢ –í–ï–©–¨ (–∂–µ–ª–∞–Ω–∏–µ, –Ω–∞–¥–µ–∂–¥–∞, –∫—Ä–∞—Å–æ—Ç–∞)
   2Ô∏è‚É£ –û–ù–ê –ë–û–†–ï–¢–°–Ø –° –†–ï–®–ï–ù–ò–ï–ú (–ø–æ–º–Ω—é –æ –¥–µ–Ω—å–≥–∞—Ö, –æ –¥–æ–ª–≥–∞—Ö)
   3Ô∏è‚É£ –û–ù–ê –ë–ï–†–Å–¢ (–º—É–∂–µ—Å—Ç–≤–æ, –≤—ã–±–æ—Ä, —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç—Ä—É–¥)
   4Ô∏è‚É£ –û–ù–ê –ü–õ–ê–¢–ò–¢ (—Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏–π –º–æ–º–µ–Ω—Ç - —Å–≤–æ–∏ –¥–µ–Ω—å–≥–∏)
   5Ô∏è‚É£ –ö–û–ù–§–õ–ò–ö–¢ –í–ó–†–´–í–ê–ï–¢–°–Ø (–∑–≤–æ–Ω–æ–∫, —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ, –≥–Ω–µ–≤)
   6Ô∏è‚É£ –§–ò–ó–ò–ß–ï–°–ö–ò–ô –ö–û–ù–§–õ–ò–ö–¢ (—Ç—è–Ω—É—Ç, —Ä–≤—É—Ç, –ø–∞–¥–∞–µ—Ç, –±–æ–ª—å)
   7Ô∏è‚É£ –ü–ï–†–ï–õ–û–ú–ù–´–ô –ú–û–ú–ï–ù–¢ (–æ–Ω–∞ –í–ò–î–ò–¢ –ø—Ä–∞–≤–¥—É, –ü–†–ò–ù–ò–ú–ê–ï–¢ —Ä–µ—à–µ–Ω–∏–µ)

‚ö° –ö–õ–ò–§–§–•–≠–ù–ì–ï–† (–≤–æ–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –¥–∞–µ—Ç —Å–ø–∞—Ç—å):
   "–°–º–æ–∂–µ—Ç –ª–∏ –æ–Ω–∞ –ø—Ä–æ—Å—Ç–∏—Ç—å –µ–≥–æ? –ò–ª–∏ —Å–Ω–∞—á–∞–ª–∞ —Å–µ–±—è?"

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–ü–†–ê–í–ò–õ–ê –ö–ê–ß–ï–°–¢–í–ê:
‚úÖ –ú–∏–Ω–∏–º—É–º 3500 —Å–∏–º–≤–æ–ª–æ–≤ (–ù–ï –ú–ï–ù–¨–®–ï!)
‚úÖ –ú–∞–∫—Å–∏–º—É–º 5000 —Å–∏–º–≤–æ–ª–æ–≤ (–Ω–µ –æ–±—Ä–µ–∑–∞–π –∫—Ä–∞—Å–∏–≤–æ–µ)
‚úÖ –ú–∏–Ω–∏–º—É–º 2-3 –¥–∏–∞–ª–æ–≥–∞ (–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ, —Ä–µ–∑–∫–∏–µ)
‚úÖ –ú–∏–Ω–∏–º—É–º 4-5 –¥–µ—Ç–∞–ª–µ–π –∏–∑ 5 —á—É–≤—Å—Ç–≤ (–∑–∞–ø–∞—Ö–∏, –∑–≤—É–∫–∏, –æ—â—É—â–µ–Ω–∏—è)
‚úÖ –ú–∏–Ω–∏–º—É–º 2-3 –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏–ª–∏ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è –≥–µ—Ä–æ–∏–Ω–∏
‚úÖ –ú–∏–Ω–∏–º—É–º 1 –ø–µ—Ä–µ–ª–æ–º–Ω—ã–π –º–æ–º–µ–Ω—Ç (–µ—ë —Ä–µ—à–µ–Ω–∏–µ –º–µ–Ω—è–µ—Ç –≤—Å—ë)
‚úÖ –¢–æ–ª—å–∫–æ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫
‚úÖ –ù–∏–∫–∞–∫–æ–≥–æ JSON, –Ω–∏–∫–∞–∫–æ–≥–æ –∫–æ–¥–∞

Output ONLY episode text (no metadata):`;
  }

  private async generateWithBreakdown(outline: EpisodeOutline): Promise<string> {
    const parts: string[] = [];

    console.log(`      üî® Generating opening (300-400 chars) in Sapogi style...`);
    const opening = await this.generateWithPrompt(
      outline,
      `–ù–ê–ü–ò–®–ò –û–¢–ö–†–´–¢–ò–ï –°–¶–ï–ù–´ (300-400 —Å–∏–º–≤–æ–ª–æ–≤):

–¢–µ–º–∞: "${outline.internalConflict}"
–í–æ–ø—Ä–æ—Å: "${outline.hookQuestion}"

–ü–†–ê–í–ò–õ–ê:
- –ü–µ—Ä–≤–æ–µ –ª–∏—Ü–æ ("—è")
- –ü–æ–∫–∞–∂–∏ –æ–¥–∏–Ω –º–æ–º–µ–Ω—Ç: –æ–±—Å—Ç–∞–Ω–æ–≤–∫–∞ + –µ—ë —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- –î–µ—Ç–∞–ª—å (–∑–∞–ø–∞—Ö, –∑–≤—É–∫, –æ—â—É—â–µ–Ω–∏–µ)
- –í–µ—â—å –∏–º–µ–µ—Ç –∏—Å—Ç–æ—Ä–∏—é ("–ú–æ–π —Å—Ç–∞—Ä—ã–π –ø–∞–ª—å—Ç–æ, –∫—É–ø–ª–µ–Ω–Ω–æ–µ –ø—è—Ç—å –ª–µ—Ç –Ω–∞–∑–∞–¥")
- –≠–º–æ—Ü–∏—è –ø–æ–∫–∞–∑–∞–Ω–∞ —á–µ—Ä–µ–∑ —Ç–µ–ª–æ, –Ω–µ —Å–ª–æ–≤–∞–º–∏
- –ö–æ–Ω–µ—Ü: –≤–æ–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –∑–∞—Ç—è–≥–∏–≤–∞–µ—Ç –≤–ø–µ—Ä–µ–¥
- –ù–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ!

Output ONLY text (no metadata):`
    );
    parts.push(opening);

    await new Promise(r => setTimeout(r, 1500));

    console.log(`      üî® Generating escalation (1000-1200 chars) with dialogue...`);
    const escalation = await this.generateWithPrompt(
      outline,
      `–ù–ê–ü–ò–®–ò –†–ê–ó–í–ò–¢–ò–ï –ö–û–ù–§–õ–ò–ö–¢–ê (1000-1200 —Å–∏–º–≤–æ–ª–æ–≤):

–ö–æ–Ω—Ñ–ª–∏–∫—Ç: "${outline.externalConflict}"
–ï—ë —á—É–≤—Å—Ç–≤–∞: "${outline.internalConflict}"

–ü–†–ê–í–ò–õ–ê:
- –ù–∞—á–Ω–∏ —Å –µ—ë –∂–µ–ª–∞–Ω–∏—è –∏–ª–∏ –¥–µ–π—Å—Ç–≤–∏—è
- –î–ò–ê–õ–û–ì–ò (–º–∏–Ω–∏–º—É–º 3-4 –∫–æ—Ä–æ—Ç–∫–∏–µ —Ä–µ–∑–∫–∏–µ —Ä–µ–ø–ª–∏–∫–∏)
- –ü–æ–∫–∞–∂–∏ –µ—ë –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è (–ø–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ)
- –ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ –ù–ê–†–ê–°–¢–ê–ï–¢
- –î–≤–∏–∂–µ–Ω–∏–µ, –¥–µ–π—Å—Ç–≤–∏–µ, —Ñ–∏–∑–∏–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞
- –ù–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ!

Output ONLY text (no metadata):`
    );
    parts.push(escalation);

    await new Promise(r => setTimeout(r, 1500));

    console.log(`      üî® Generating climax (600-800 chars) - the turning point...`);
    const climax = await this.generateWithPrompt(
      outline,
      `–ù–ê–ü–ò–®–ò –ö–£–õ–¨–ú–ò–ù–ê–¶–ò–Æ - –ü–ï–†–ï–õ–û–ú–ù–´–ô –ú–û–ú–ï–ù–¢ (600-800 —Å–∏–º–≤–æ–ª–æ–≤):

–ü–µ—Ä–µ–ª–æ–º–Ω—ã–π –º–æ–º–µ–Ω—Ç: "${outline.keyTurning}"

–ü–†–ê–í–ò–õ–ê:
- –≠–¢–û –ü–ò–ö–û–í–´–ô –ú–û–ú–ï–ù–¢ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞
- –§–∏–∑–∏—á–µ—Å–∫–∏–π –≤–∑—Ä—ã–≤ –ò–õ–ò —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –æ—Ç–∫—Ä–æ–≤–µ–Ω–∏–µ
- –ï–Å –†–ï–®–ï–ù–ò–ï / –ï–Å –ü–û–ù–ò–ú–ê–ù–ò–ï –º–µ–Ω—è–µ—Ç –í–°–Å
- –ü–æ–∫–∞–∑—ã–≤–∞–π —á–µ—Ä–µ–∑ —Ç–µ–ª–æ: "–í–Ω—É—Ç—Ä–∏ –º–µ–Ω—è —á—Ç–æ-—Ç–æ —â–µ–ª–∫–Ω—É–ª–æ"
- –ß–∏—Ç–∞—Ç–µ–ª—å –ø–æ–Ω–∏–º–∞–µ—Ç: –î–ê, –≠–¢–û–¢ –ú–û–ú–ï–ù–¢ –≤—Å—ë –ø–µ—Ä–µ–≤–µ—Ä–Ω—É–ª
- –ù–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ!

Output ONLY text (no metadata):`
    );
    parts.push(climax);

    await new Promise(r => setTimeout(r, 1500));

    console.log(`      üî® Generating resolution (400-600 chars) - new reality...`);
    const resolution = await this.generateWithPrompt(
      outline,
      `–ù–ê–ü–ò–®–ò –†–ê–ó–í–Ø–ó–ö–£ - –ù–û–í–£–Æ –†–ï–ê–õ–¨–ù–û–°–¢–¨ (400-600 —Å–∏–º–≤–æ–ª–æ–≤):

–ü–æ—Å–ª–µ –ø–µ—Ä–µ–ª–æ–º–Ω–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞: "${outline.keyTurning}"
–û–Ω–∞ —Ç–µ–ø–µ—Ä—å –∑–Ω–∞–µ—Ç: "${outline.openLoop}"

–ü–†–ê–í–ò–õ–ê:
- –ï—ë –Ω–æ–≤–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ
- –ß—Ç–æ –æ–Ω–∞ —á—É–≤—Å—Ç–≤—É–µ—Ç –ü–û–°–õ–ï —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞
- –ï—ë –≤—ã–±–æ—Ä / –µ—ë –¥–µ–π—Å—Ç–≤–∏–µ
- –ù–µ–±–æ–ª—å—à–æ–π –∫–æ–Ω—Ç—Ä–∞—Å—Ç —Å —Ç–µ–º, —á—Ç–æ –±—ã–ª–æ
- –ö–æ–Ω–µ—Ü –ø–æ–≤–∏—Å–∞–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–º: —á—Ç–æ –±—É–¥–µ—Ç –¥–∞–ª—å—à–µ?
- –ù–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ!

Output ONLY text (no metadata):`
    );
    parts.push(resolution);

    return parts.filter(p => p.length > 0).join("\n\n");
  }

  private async generateFallback(outline: EpisodeOutline): Promise<string> {
    console.log(`      üÜò Generating PART 1 (2000-2500 chars)...`);
    const part1 = await this.generateWithPrompt(
      outline,
      `–ù–ê–ü–ò–®–ò –ü–ï–†–í–£–Æ –ß–ê–°–¢–¨ –î–õ–ò–ù–ù–û–ô –°–¶–ï–ù–´ (2000-2500 —Å–∏–º–≤–æ–ª–æ–≤):

–ì–µ—Ä–æ–∏–Ω—è: "${outline.internalConflict}"
–ï—ë –≤–æ–ø—Ä–æ—Å: "${outline.hookQuestion}"
–ö–æ–Ω—Ñ–ª–∏–∫—Ç: "${outline.externalConflict}"

–ß–¢–û –ù–£–ñ–ù–û –í–ö–õ–Æ–ß–ò–¢–¨:
- –û—Ç–∫—Ä—ã—Ç–∏–µ: –æ–±—Å—Ç–∞–Ω–æ–≤–∫–∞ + –µ—ë —Å–æ—Å—Ç–æ—è–Ω–∏–µ + –¥–µ—Ç–∞–ª—å (–∑–∞–ø–∞—Ö/–∑–≤—É–∫)
- –ï—ë –∂–µ–ª–∞–Ω–∏–µ –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞
- –í–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ: –ø–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ
- –ï—ë –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –º–æ–Ω–æ–ª–æ–≥: –º—ã—Å–ª–∏, —Å—Ç—Ä–∞—Ö–∏
- –î–µ–π—Å—Ç–≤–∏–µ: —á—Ç–æ-—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
- –î–∏–∞–ª–æ–≥: –∫–æ–Ω—Ñ–ª–∏–∫—Ç –∑—Ä–µ–µ—Ç
- –ö–æ–Ω–µ—Ü —á–∞—Å—Ç–∏: —Ç—Ä–µ–≤–æ–≥–∞, –≤–æ–ø—Ä–æ—Å

–ü–†–ê–í–ò–õ–ê:
- –ü–µ—Ä–≤–æ–µ –ª–∏—Ü–æ ("—è")
- –ú–Ω–æ–≥–æ –¥–µ—Ç–∞–ª–µ–π —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏
- –ú–∏–Ω–∏–º—É–º 2 –¥–∏–∞–ª–æ–≥–∞
- –ú–∏–Ω–∏–º—É–º 1 –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ
- –ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ –ù–ê–†–ê–°–¢–ê–ï–¢ –∫ –∫–æ–Ω—Ü—É
- –ù–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ!

Output ONLY text (no metadata):`
    );

    await new Promise(r => setTimeout(r, 2000));

    console.log(`      üÜò Generating PART 2 (2000-2500 chars)...`);
    const part2 = await this.generateWithPrompt(
      outline,
      `–ù–ê–ü–ò–®–ò –í–¢–û–†–£–Æ –ß–ê–°–¢–¨ –î–õ–ò–ù–ù–û–ô –°–¶–ï–ù–´ (2000-2500 —Å–∏–º–≤–æ–ª–æ–≤):

–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏:
–ü–µ—Ä–µ–ª–æ–º–Ω—ã–π –º–æ–º–µ–Ω—Ç: "${outline.keyTurning}"
–ù–∞ —á—Ç–æ –æ–Ω–∞ –∂–¥—ë—Ç –æ—Ç–≤–µ—Ç–∞: "${outline.openLoop}"

–ß–¢–û –ù–£–ñ–ù–û –í–ö–õ–Æ–ß–ò–¢–¨:
- –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –∏–∑ Part 1
- –ö–£–õ–¨–ú–ò–ù–ê–¶–ò–Ø: –≤–∑—Ä—ã–≤ –∏–ª–∏ –æ–∑–∞—Ä–µ–Ω–∏–µ
- –ï—ë –†–ï–®–ï–ù–ò–ï –∏–ª–∏ –ü–û–ù–ò–ú–ê–ù–ò–ï –º–µ–Ω—è–µ—Ç –í–°–Å
- "–í–Ω—É—Ç—Ä–∏ –º–µ–Ω—è —á—Ç–æ-—Ç–æ —â–µ–ª–∫–Ω—É–ª–æ"
- –ï—ë –î–ï–ô–°–¢–í–ò–ï (–∑–≤–æ–Ω–æ–∫, —É—Ö–æ–¥, —Å–ª–æ–≤–∞, –≤—ã–±–æ—Ä)
- –†–∞–∑–≤—è–∑–∫–∞: –Ω–æ–≤–∞—è —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å
- –í–û–ü–†–û–° –≤ –∫–æ–Ω—Ü–µ: —á—Ç–æ –±—É–¥–µ—Ç –¥–∞–ª—å—à–µ?

–ü–†–ê–í–ò–õ–ê:
- –°–∏–ª—å–Ω—ã–µ —ç–º–æ—Ü–∏–∏, –ø–æ–∫–∞–∑–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ —Ç–µ–ª–æ
- –§–∏–∑–∏—á–µ—Å–∫–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ (—Ä—ã–≤–æ–∫, –¥–≤–∏–∂–µ–Ω–∏–µ, —Ç–µ–ª–µ—Ñ–æ–Ω)
- –ï—ë –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –≥–æ–ª–æ—Å
- –î–∏–∞–ª–æ–≥ –∏–ª–∏ –º–æ–Ω–æ–ª–æ–≥
- –ö–ª–∏—Ñ—Ñ—Ö—ç–Ω–≥–µ—Ä –≤ –∫–æ–Ω—Ü–µ (–≤–æ–ø—Ä–æ—Å, –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å)
- –ù–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ!

Output ONLY text (no metadata):`
    );

    const combined = part1 + "\n\n" + part2;

    if (combined.length < 3500) {
      console.log(`      ‚ö†Ô∏è  Fallback too short (${combined.length}), trying emergency...`);
      return await this.generateEmergency(outline);
    }

    return combined;
  }

  private async generateEmergency(outline: EpisodeOutline): Promise<string> {
    console.log(`      üö® EMERGENCY MODE: Raw generation (4000+ chars MINIMUM)`);

    const prompt = `üö® –°–†–û–ß–ù–û! –ù–ê–ü–ò–®–ò –ü–û–õ–ù–´–ô –†–ê–°–°–ö–ê–ó –ë–ï–ó –°–û–ö–†–ê–©–ï–ù–ò–ô (4000+ —Å–∏–º–≤–æ–ª–æ–≤ –ú–ò–ù–ò–ú–£–ú):

–ì–ï–†–û–ò–ù–Ø: ${outline.internalConflict}

–ï–Å –í–û–ü–†–û–° (–æ—Ç–∫—Ä—ã–≤–∞—é—â–∏–π –º–æ–º–µ–Ω—Ç): "${outline.hookQuestion}"

–ß–¢–û –ü–†–û–ò–ó–û–®–õ–û (–≤–Ω–µ—à–Ω–∏–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç): ${outline.externalConflict}

–ß–¢–û –û–ù–ê –ß–£–í–°–¢–í–û–í–ê–õ–ê (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç): ${outline.internalConflict}

–ü–ï–†–ï–õ–û–ú–ù–´–ô –ú–û–ú–ï–ù–¢ (–≤—Å—ë –∏–∑–º–µ–Ω–∏–ª–æ—Å—å): ${outline.keyTurning}

–¢–ï–ü–ï–†–¨ –û–ù–ê –°–ü–†–ê–®–ò–í–ê–ï–¢ –°–ï–ë–Ø: ${outline.openLoop}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–ü–†–ê–í–ò–õ–ê "–°–ê–ü–û–ì–ò" –°–¢–ò–õ–Ø (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!):

1. –ü–ï–†–í–û–ï –õ–ò–¶–û ("—è", "–º–Ω–µ", "–º–æ–∏")

2. –î–ï–¢–ê–õ–ò –†–ï–ê–õ–¨–ù–û–°–¢–ò:
   - –ó–∞–ø–∞—Ö–∏: "–ó–∞–ø–∞—Ö –Ω–æ–≤–æ–π –∫–æ–∂–∏ —É–¥–∞—Ä–∏–ª –≤ –Ω–æ—Å"
   - –ó–≤—É–∫–∏: "–ö–∞–∂–¥—ã–π —à–∞–≥ –æ—Ç–¥–∞–≤–∞–ª—Å—è —Ö–ª—é–ø–∞—é—â–∏–º –∑–≤—É–∫–æ–º"
   - –û—â—É—â–µ–Ω–∏—è: "–°–µ—Ä–¥—Ü–µ —Å–¥–µ–ª–∞–ª–æ –Ω–µ–ø—Ä–∏—è—Ç–Ω—ã–π –∫—É–ª—å–±–∏—Ç"
   - –í–µ—â–∏ –∏–º–µ—é—Ç –ò–°–¢–û–†–ò–Æ: "–°–∞–ø–æ–≥–∏, –∫—É–ø–ª–µ–Ω–Ω—ã–µ —Ç—Ä–∏ –≥–æ–¥–∞ –Ω–∞–∑–∞–¥"

3. –í–ù–£–¢–†–ï–ù–ù–ò–ô –ì–û–õ–û–°:
   - –ï—ë —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è: "–î–≤–∞ –º–µ—Å—è—Ü–∞ —è –µ–ª–∞ –ø—É—Å—Ç—É—é –≥—Ä–µ—á–∫—É..."
   - –ï—ë –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è: "–ó–∞ –ø—è—Ç—å –ª–µ—Ç —è –ø–æ–Ω—è–ª–∞..."
   - –ï—ë –±–æ–ª—å: "–í–Ω—É—Ç—Ä–∏ –º–µ–Ω—è —á—Ç–æ-—Ç–æ —â–µ–ª–∫–Ω—É–ª–æ"

4. –î–ò–ê–õ–û–ì–ò (–∫—Ä–∞—Ç–∫–∏–µ, —Ä–µ–∑–∫–∏–µ):
   ‚Äî –≠—Ç–æ —á—Ç–æ?
   ‚Äî –°–∞–ø–æ–≥–∏.
   ‚Äî –ó–∞ —Å–∫–æ–ª—å–∫–æ?
   ‚Äî –ó–∞ –ø—è—Ç–Ω–∞–¥—Ü–∞—Ç—å.

5. –î–ï–ô–°–¢–í–ò–ï –ö–ê–ö –í –ö–ò–ù–û:
   "–û–Ω —Å—Ö–≤–∞—Ç–∏–ª —Ä—É—á–∫–∏ –ø–∞–∫–µ—Ç–∞ –æ–±–µ–∏–º–∏ —Ä—É–∫–∞–º–∏. –Ø –¥–µ—Ä–Ω—É–ª–∞ –Ω–∞ —Å–µ–±—è. 
    –ö–∞—Ä—Ç–æ–Ω–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞ –∑–∞—Ç—Ä–µ—â–∞–ª–∞..."

6. –°–¢–†–£–ö–¢–£–†–ê:
   - –û—Ç–∫—Ä—ã—Ç–∏–µ (–æ–±—Å—Ç–∞–Ω–æ–≤–∫–∞ + –µ—ë —Å–æ—Å—Ç–æ—è–Ω–∏–µ)
   - –†–∞–∑–≤–∏—Ç–∏–µ (–µ—ë –∂–µ–ª–∞–Ω–∏–µ, –∫–æ–Ω—Ñ–ª–∏–∫—Ç –∑—Ä–µ–µ—Ç)
   - –ö—É–ª—å–º–∏–Ω–∞—Ü–∏—è (–í–ó–†–´–í, –û–ó–ê–†–ï–ù–ò–ï)
   - –ï—ë —Ä–µ—à–µ–Ω–∏–µ –º–µ–Ω—è–µ—Ç –í–°–Å
   - –†–∞–∑–≤—è–∑–∫–∞ (–Ω–æ–≤–∞—è —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å)
   - –í–æ–ø—Ä–æ—Å (—á—Ç–æ –±—É–¥–µ—Ç –¥–∞–ª—å—à–µ?)

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–ú–ò–ù–ò–ú–£–ú 4000 —Å–∏–º–≤–æ–ª–æ–≤. –ë–ï–ó –°–û–ö–†–ê–©–ï–ù–ò–ô!
–†–∞—Å—Å–∫–∞–∂–∏ –ü–û–õ–ù–´–ô —Ä–∞—Å—Å–∫–∞–∑, –Ω–µ —Å–ø–µ—à–∏!
–ù–∏–∫–∞–∫–æ–≥–æ JSON, –Ω–∏–∫–∞–∫–æ–≥–æ –∫–æ–¥–∞, —Ç–æ–ª—å–∫–æ –¢–ï–ö–°–¢!
–ù–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ!

Output ONLY text:`;

    return await this.generateWithPrompt(outline, prompt);
  }

  private async generateWithPrompt(
    outline: EpisodeOutline,
    prompt: string
  ): Promise<string> {
    try {
      const response = await this.geminiClient.models.generateContent({
        model: "gemini-2.5-flash",
        contents: prompt,
        config: {
          temperature: 0.95,
          topK: 40,
          topP: 0.95,
          maxOutputTokens: 2500,
        },
      });

      let content = response.text || "";

      content = ContentSanitizer.cleanEpisodeContent(content);

      return content;
    } catch (error) {
      console.error(`   ‚ùå Gemini call failed:`, (error as Error).message);
      return "";
    }
  }

  private isValidLength(content: string): boolean {
    const cleaned = ContentSanitizer.cleanEpisodeContent(content);
    return cleaned.length >= 3000;
  }

  private buildEpisode(outline: EpisodeOutline, content: string): Episode {
    const cleaned = ContentSanitizer.cleanEpisodeContent(content);
    const validation = ContentSanitizer.validateEpisodeContent(cleaned);

    console.log(
      `   ‚úÖ Episode #${outline.id} complete: ${validation.charCount} chars (${validation.wordCount} words)`
    );

    if (validation.warnings.length > 0) {
      validation.warnings.forEach(w => console.log(`   ${w}`));
    }

    return {
      id: outline.id,
      title: `Episode ${outline.id}`,
      content: cleaned,
      charCount: validation.charCount,
      openLoop: outline.openLoop,
      turnPoints: [outline.keyTurning],
      emotions: [outline.internalConflict],
      keyScenes: [],
      characters: [],
      generatedAt: Date.now(),
      stage: "draft",
    };
  }

  async generateEpisodesSequentially(
    outlines: EpisodeOutline[],
    options: {
      delayBetweenRequests?: number;
      onProgress?: (current: number, total: number) => void;
    } = {}
  ): Promise<Episode[]> {
    const delay = options.delayBetweenRequests || 1500;
    const results: Episode[] = [];

    console.log(`\nüîÑ Generating ${outlines.length} episodes SEQUENTIALLY...`);

    for (let i = 0; i < outlines.length; i++) {
      const outline = outlines[i];

      try {
        // üñºÔ∏è –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ + –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const episodeWithImage = await this.generateSingleEpisodeWithImage(outline);
        results.push(episodeWithImage);

        if (options.onProgress) {
          options.onProgress(i + 1, outlines.length);
        }

        if (i < outlines.length - 1) {
          console.log(`   ‚è≥ Waiting ${delay}ms before next episode...\n`);
          await new Promise(resolve => setTimeout(resolve, delay));
        }
      } catch (error) {
        console.error(`\n‚ùå FAILED: Episode #${outline.id}`);
        throw error;
      }
    }

    return results;
  }
}
